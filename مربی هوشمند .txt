<!DOCTYPE html><html lang="fa" dir="rtl"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مربی هوشمند - سیستم تحلیل علمی پیشرفته</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#667eea',
                        accent: '#764ba2',
                        dark: '#0f0f23',
                        'dark-card': '#1a1a2e',
                        'dark-hover': '#16213e'
                    },
                    fontFamily: {
                        'vazir': ['Vazirmatn', 'Tahoma', 'Arial', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'bounce-soft': 'bounceSoft 1s infinite',
                        'shake': 'shake 0.5s ease-in-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' }
                        },
                        bounceSoft: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }
                        },
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '25%': { transform: 'translateX(-5px)' },
                            '75%': { transform: 'translateX(5px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Vazirmatn', 'Tahoma', 'Arial', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #5D5CDE 0%, #667eea 50%, #764ba2 100%);
        }
        
        .gradient-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .input-field {
            background-color: #ffffff;
            border: 2px solid #e5e7eb;
            color: #1f2937;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .input-field:focus {
            border-color: #5D5CDE;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
            outline: none;
            background-color: #ffffff;
        }
        
        .dark .input-field {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        
        .dark .input-field:focus {
            background-color: #374151;
            border-color: #5D5CDE;
            color: #f9fafb;
        }
        
        .select-field {
            background-color: #ffffff;
            border: 2px solid #e5e7eb;
            color: #1f2937;
            font-size: 16px;
        }
        
        .select-field:focus {
            border-color: #5D5CDE;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
            outline: none;
        }
        
        .dark .select-field {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        
        .dark .select-field:focus {
            border-color: #5D5CDE;
            color: #f9fafb;
        }
        
        .card-shadow {
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
        }
        
        .card-shadow:hover {
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .progress-glow {
            background: linear-gradient(90deg, #5D5CDE 0%, #667eea 50%, #764ba2 100%);
            box-shadow: 0 0 20px rgba(93, 92, 222, 0.3);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #5D5CDE 0%, #667eea 100%);
            color: white;
        }
        
        .metric-card {
            background: linear-gradient(145deg, rgba(93, 92, 222, 0.05) 0%, rgba(102, 126, 234, 0.03) 100%);
            border: 1px solid rgba(93, 92, 222, 0.1);
        }
        
        .dark .metric-card {
            background: linear-gradient(145deg, rgba(93, 92, 222, 0.1) 0%, rgba(102, 126, 234, 0.05) 100%);
            border: 1px solid rgba(93, 92, 222, 0.2);
        }
        
        .option-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .option-card:hover {
            background-color: rgba(93, 92, 222, 0.1);
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.15) 0%, rgba(102, 126, 234, 0.1) 100%);
            border: 2px solid #5D5CDE;
        }
        
        input[type="radio"]:checked + .option-card {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.15) 0%, rgba(102, 126, 234, 0.1) 100%);
            border: 2px solid #5D5CDE;
        }
        
        input[type="checkbox"]:checked + .option-card {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.15) 0%, rgba(102, 126, 234, 0.1) 100%);
            border: 2px solid #5D5CDE;
        }

        .analysis-result {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1) 0%, rgba(102, 126, 234, 0.05) 100%);
            border: 2px solid rgba(93, 92, 222, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 10px 0;
        }

        .progress-indicator {
            position: relative;
            height: 4px;
            background: rgba(93, 92, 222, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #5D5CDE, #667eea);
            border-radius: 2px;
            transition: width 0.7s ease;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #5D5CDE, #667eea);
            border-radius: 10px;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #2d2d44;
        }

        .error-input {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            animation: shake 0.5s ease-in-out;
        }

        .success-input {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-gray-900 dark:text-white transition-all duration-300 font-vazir">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-dark-card shadow-lg border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 backdrop-blur-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 gradient-primary rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">مربی هوشمند</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="exportData" class="hidden p-2 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors" title="دانلود برنامه">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"></path>
                            </svg>
                        </button>
                        <button id="themeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg id="sunIcon" class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                            </svg>
                            <svg id="moonIcon" class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Welcome Section -->
            <div id="welcomeSection" class="text-center mb-12 animate-fade-in">
                <div class="gradient-primary rounded-3xl p-12 text-white mb-8 card-shadow">
                    <h2 class="text-4xl font-bold mb-6">🧠 سیستم تحلیل علمی پیشرفته</h2>
                    <p class="text-xl opacity-90 max-w-3xl mx-auto mb-8 leading-relaxed">
                        با الگوریتم‌های علمی و هوش مصنوعی، برنامه ورزشی کاملاً شخصی‌سازی‌شده و منحصر به فرد دریافت کنید
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                        <div class="glass-effect rounded-2xl p-6">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">🔬</span>
                            </div>
                            <h3 class="font-semibold mb-2">تحلیل علمی 100% دقیق</h3>
                            <p class="text-sm opacity-80">الگوریتم‌های مبتنی بر آخرین تحقیقات ورزشی</p>
                        </div>
                        <div class="glass-effect rounded-2xl p-6">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">🎯</span>
                            </div>
                            <h3 class="font-semibold mb-2">شخصی‌سازی مطلق</h3>
                            <p class="text-sm opacity-80">برنامه منحصر به فرد برای هر کاربر</p>
                        </div>
                        <div class="glass-effect rounded-2xl p-6">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">📊</span>
                            </div>
                            <h3 class="font-semibold mb-2">نتایج تضمین‌شده</h3>
                            <p class="text-sm opacity-80">پیگیری دقیق پیشرفت و تنظیم خودکار</p>
                        </div>
                    </div>
                </div>
                <button id="startAssessment" class="gradient-primary text-white px-12 py-4 rounded-2xl text-lg font-semibold transition-all duration-300 shadow-xl hover:shadow-2xl hover:scale-105 animate-pulse-soft">
                    🚀 شروع تحلیل هوشمند
                </button>
            </div>

            <!-- Assessment Form -->
            <div id="assessmentForm" class="hidden animate-slide-up">
                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-2xl overflow-hidden">
                    <!-- Progress Header -->
                    <div class="gradient-primary p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold">تحلیل علمی جامع</h3>
                            <div class="flex items-center gap-3">
                                <span class="text-sm opacity-80">مرحله</span>
                                <span id="currentStep" class="text-lg font-bold bg-white/20 px-3 py-1 rounded-full">1</span>
                                <span class="text-sm opacity-80">از</span>
                                <span id="totalSteps" class="text-lg font-bold">8</span>
                            </div>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-3 overflow-hidden">
                            <div id="progressBar" class="progress-glow h-3 rounded-full transition-all duration-700 ease-out" style="width: 12.5%"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs opacity-70">
                            <span>شروع</span>
                            <span id="progressPercent">12.5%</span>
                            <span>اتمام</span>
                        </div>
                    </div>

                    <!-- Form Content -->
                    <div class="p-8">
                        <!-- Step 1: Basic Info -->
                        <div id="step1" class="step space-y-6">
                            <div class="text-center mb-8">
                                <h4 class="text-2xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">📊 اطلاعات بیومتریک</h4>
                                <p class="text-gray-600 dark:text-gray-400">پایه علمی تحلیل شما</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">سن (سال) *</label>
                                    <input type="number" id="age" class="w-full p-4 rounded-xl input-field" placeholder="مثال: 25" min="15" max="80" required="">
                                    <div id="ageHelp" class="text-xs text-gray-500">برای محاسبه BMR و هورمون‌ها</div>
                                </div>
                                
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">جنسیت *</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="option-card p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 cursor-pointer">
                                            <input type="radio" name="gender" value="male" class="hidden" required="">
                                            <div class="text-center">
                                                <span class="text-2xl mb-2 block">👨</span>
                                                <span class="font-medium">مرد</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 cursor-pointer">
                                            <input type="radio" name="gender" value="female" class="hidden" required="">
                                            <div class="text-center">
                                                <span class="text-2xl mb-2 block">👩</span>
                                                <span class="font-medium">زن</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">قد (سانتی‌متر) *</label>
                                    <input type="number" id="height" class="w-full p-4 rounded-xl input-field" placeholder="مثال: 175" min="140" max="220" step="0.5" required="">
                                    <div class="text-xs text-gray-500">صبح، بدون کفش اندازه‌گیری کنید</div>
                                </div>
                                
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">وزن فعلی (کیلوگرم) *</label>
                                    <input type="number" id="weight" class="w-full p-4 rounded-xl input-field" placeholder="مثال: 70" min="35" max="200" step="0.1" required="">
                                    <div class="text-xs text-gray-500">صبح، ناشتا و بدون لباس</div>
                                </div>
                                
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">وزن هدف (کیلوگرم) *</label>
                                    <input type="number" id="targetWeight" class="w-full p-4 rounded-xl input-field" placeholder="مثال: 65" min="35" max="200" step="0.1" required="">
                                    <div class="text-xs text-gray-500">هدف واقع‌بینانه انتخاب کنید</div>
                                </div>
                                
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">درصد چربی بدن</label>
                                    <input type="number" id="bodyFat" class="w-full p-4 rounded-xl input-field" placeholder="اختیاری" min="5" max="50" step="0.1">
                                    <div class="text-xs text-gray-500">اگر با دستگاه DEXA یا Bod Pod اندازه‌گیری شده</div>
                                </div>
                            </div>

                            <!-- Real-time BMI Calculator -->
                            <div id="bmiResult" class="hidden analysis-result">
                                <h5 class="font-semibold text-primary mb-3 flex items-center">
                                    <span class="text-xl mr-2">📏</span>
                                    تحلیل اولیه ترکیب بدن:
                                </h5>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-lg font-bold text-primary" id="bmiValue"></div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">BMI</div>
                                    </div>
                                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-lg font-bold" id="bmiCategory"></div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">طبقه‌بندی</div>
                                    </div>
                                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-lg font-bold text-blue-600" id="bmrEstimate"></div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">BMR تخمینی</div>
                                    </div>
                                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-lg font-bold text-green-600" id="bodyFatEstimate"></div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">چربی تخمینی</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Fitness Assessment -->
                        <div id="step2" class="step hidden space-y-6">
                            <div class="text-center mb-8">
                                <h4 class="text-2xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">💪 ارزیابی آمادگی فعلی</h4>
                                <p class="text-gray-600 dark:text-gray-400">تست‌های عملکردی استاندارد</p>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="space-y-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🏋️</span>
                                            تست‌های قدرت
                                        </h5>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-2">شنای سینه استاندارد (تعداد)</label>
                                                <input type="number" id="pushupMax" class="w-full p-3 rounded-lg input-field" placeholder="0" min="0" max="100">
                                                <div class="text-xs text-gray-500 mt-1">بدون استراحت، فرم کامل</div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">پلانک استاندارد (ثانیه)</label>
                                                <input type="number" id="plankTime" class="w-full p-3 rounded-lg input-field" placeholder="0" min="0" max="600">
                                                <div class="text-xs text-gray-500 mt-1">حداکثر زمان حفظ فرم صحیح</div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">بارفیکس (تعداد)</label>
                                                <input type="number" id="pullupMax" class="w-full p-3 rounded-lg input-field" placeholder="0" min="0" max="50">
                                                <div class="text-xs text-gray-500 mt-1">اختیاری - کامل از بالا تا پایین</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🤸</span>
                                            انعطاف‌پذیری
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="flexibility" value="poor" class="hidden">
                                                <div>
                                                    <div class="font-medium">ضعیف</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">دست به زانو نمی‌رسد</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="flexibility" value="fair" class="hidden">
                                                <div>
                                                    <div class="font-medium">متوسط</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">دست به قوزک پا می‌رسد</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="flexibility" value="good" class="hidden">
                                                <div>
                                                    <div class="font-medium">خوب</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">دست به کف پا می‌رسد</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="flexibility" value="excellent" class="hidden">
                                                <div>
                                                    <div class="font-medium">عالی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کف دست روی زمین می‌نشیند</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">❤️</span>
                                            استقامت قلبی-عروقی
                                        </h5>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-2">دویدن مداوم (دقیقه)</label>
                                                <input type="number" id="runningTime" class="w-full p-3 rounded-lg input-field" placeholder="0" min="0" max="120">
                                                <div class="text-xs text-gray-500 mt-1">بدون توقف، سرعت متوسط</div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">ضربان قلب استراحت (BPM)</label>
                                                <input type="number" id="restingHR" class="w-full p-3 rounded-lg input-field" placeholder="70" min="40" max="120">
                                                <div class="text-xs text-gray-500 mt-1">صبح، 5 دقیقه بعد از بیدار شدن</div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">ریکاوری قلبی (دقیقه)</label>
                                                <select id="recoveryRate" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="fast">سریع (کمتر از 2 دقیقه)</option>
                                                    <option value="normal">متوسط (2-5 دقیقه)</option>
                                                    <option value="slow">کند (بیش از 5 دقیقه)</option>
                                                </select>
                                                <div class="text-xs text-gray-500 mt-1">زمان برگشت ضربان به حالت عادی</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">📈</span>
                                            سابقه ورزشی
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="experience" value="none" class="hidden">
                                                <div>
                                                    <div class="font-medium">هیچ سابقه ندارم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">اولین بار</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="experience" value="beginner" class="hidden">
                                                <div>
                                                    <div class="font-medium">تازه‌کار</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کمتر از 6 ماه</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="experience" value="intermediate" class="hidden">
                                                <div>
                                                    <div class="font-medium">متوسط</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">6 ماه تا 2 سال</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="experience" value="advanced" class="hidden">
                                                <div>
                                                    <div class="font-medium">پیشرفته</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">2 تا 5 سال</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="experience" value="expert" class="hidden">
                                                <div>
                                                    <div class="font-medium">حرفه‌ای</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">بیش از 5 سال</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Fitness Level Analysis -->
                            <div id="fitnessResult" class="hidden analysis-result">
                                <h5 class="font-semibold text-primary mb-3 flex items-center">
                                    <span class="text-xl mr-2">📊</span>
                                    تحلیل سطح آمادگی:
                                </h5>
                                <div id="fitnessAnalysis"></div>
                            </div>
                        </div>

                        <!-- Step 3: Body Type & Metabolism -->
                        <div id="step3" class="step hidden space-y-6">
                            <div class="text-center mb-8">
                                <h4 class="text-2xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">🧬 تحلیل ژنتیک ورزشی</h4>
                                <p class="text-gray-600 dark:text-gray-400">سوماتوتایپ و نرخ متابولیسم شما</p>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="space-y-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">⚖️</span>
                                            الگوی تغییر وزن
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="weightPattern" value="gain_very_easy" class="hidden">
                                                <div>
                                                    <div class="font-medium">خیلی آسان وزن اضافه می‌کنم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">فقط نگاه کنم به غذا!</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="weightPattern" value="gain_easy" class="hidden">
                                                <div>
                                                    <div class="font-medium">به راحتی وزن اضافه می‌کنم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">چند روز بی‌احتیاطی کافیه</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="weightPattern" value="stable" class="hidden">
                                                <div>
                                                    <div class="font-medium">وزنم ثابت می‌ماند</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تغییرات خیلی کم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="weightPattern" value="lose_easy" class="hidden">
                                                <div>
                                                    <div class="font-medium">به راحتی وزن کم می‌کنم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کم غذا بخورم، فوری لاغر می‌شم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="weightPattern" value="lose_very_hard" class="hidden">
                                                <div>
                                                    <div class="font-medium">خیلی سخت وزن کم می‌کنم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">با سخت‌ترین رژیم هم نتیجه نمی‌گیرم</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🦴</span>
                                            ساختار استخوان
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="frameSize" value="small" class="hidden">
                                                <div>
                                                    <div class="font-medium">ظریف</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">مچ‌ها کوچک، شانه‌ها باریک</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="frameSize" value="medium" class="hidden">
                                                <div>
                                                    <div class="font-medium">متوسط</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تناسب طبیعی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="frameSize" value="large" class="hidden">
                                                <div>
                                                    <div class="font-medium">درشت</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">مچ‌ها بزرگ، شانه‌ها پهن</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">💪</span>
                                            توانایی عضله‌سازی
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="muscleGain" value="very_easy" class="hidden">
                                                <div>
                                                    <div class="font-medium">فوق‌العاده آسان</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">چند هفته تمرین، تغییر محسوس</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="muscleGain" value="easy" class="hidden">
                                                <div>
                                                    <div class="font-medium">آسان</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">با تمرین منظم عضله می‌گیرم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="muscleGain" value="moderate" class="hidden">
                                                <div>
                                                    <div class="font-medium">متوسط</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">نیاز به تلاش قابل توجه</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="muscleGain" value="hard" class="hidden">
                                                <div>
                                                    <div class="font-medium">سخت</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تلاش زیاد برای تغییرات کم</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🍽️</span>
                                            الگوی اشتها
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="appetitePattern" value="always_hungry" class="hidden">
                                                <div>
                                                    <div class="font-medium">همیشه گرسنه‌ام</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">یک ساعت بعد از غذا دوباره!</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="appetitePattern" value="normal" class="hidden">
                                                <div>
                                                    <div class="font-medium">اشتهای طبیعی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">3 وعده معمولی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="appetitePattern" value="low" class="hidden">
                                                <div>
                                                    <div class="font-medium">اشتهای کم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">باید یادآوری کنم که غذا بخورم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="appetitePattern" value="very_low" class="hidden">
                                                <div>
                                                    <div class="font-medium">اشتهای خیلی کم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">مجبور می‌شم خودم رو وادار کنم</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🔥</span>
                                            نرخ سوخت‌وساز
                                        </h5>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-2">دمای بدن معمولی</label>
                                                <select id="bodyTemp" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="cold">همیشه سردم می‌شود</option>
                                                    <option value="normal">طبیعی</option>
                                                    <option value="warm">همیشه گرمم می‌شود</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">انرژی پس از غذا</label>
                                                <select id="postMealEnergy" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="sleepy">خواب‌آلود می‌شوم</option>
                                                    <option value="normal">عادی</option>
                                                    <option value="energetic">پرانرژی می‌شوم</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🍰</span>
                                            ترجیحات غذایی
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="foodCravings" value="carbs" class="hidden">
                                                <div>
                                                    <div class="font-medium">نان، برنج، شیرینی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">خیلی می‌خوام</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="foodCravings" value="protein" class="hidden">
                                                <div>
                                                    <div class="font-medium">گوشت، مرغ، ماهی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">میل زیادی دارم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="foodCravings" value="fats" class="hidden">
                                                <div>
                                                    <div class="font-medium">آجیل، روغن، پنیر</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">دوست دارم</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Body Type Result -->
                            <div id="bodyTypeResult" class="hidden analysis-result">
                                <h5 class="font-semibold text-primary mb-3 flex items-center">
                                    <span class="text-xl mr-2">🧬</span>
                                    تحلیل نوع بدن (سوماتوتایپ):
                                </h5>
                                <div id="bodyTypeAnalysis"></div>
                            </div>
                        </div>

                        <!-- Step 4: Goals & Timeline -->
                        <div id="step4" class="step hidden space-y-6">
                            <div class="text-center mb-8">
                                <h4 class="text-2xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">🎯 هدف‌گذاری هوشمند</h4>
                                <p class="text-gray-600 dark:text-gray-400">تعیین اهداف SMART و زمان‌بندی</p>
                            </div>

                            <div class="space-y-8">
                                <div class="metric-card p-6 rounded-2xl">
                                    <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                        <span class="text-xl mr-2">🏆</span>
                                        هدف اصلی شما *
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="weight_loss" class="hidden" required="">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">⚖️</span>
                                                <div class="font-medium">کاهش وزن</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">سوزاندن چربی</div>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="muscle_gain" class="hidden">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">💪</span>
                                                <div class="font-medium">افزایش عضله</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">هایپرتروفی</div>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="strength" class="hidden">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">🏋️</span>
                                                <div class="font-medium">افزایش قدرت</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">پاورلیفتینگ</div>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="endurance" class="hidden">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">🏃</span>
                                                <div class="font-medium">استقامت</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">قلبی-عروقی</div>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="martial_arts" class="hidden">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">🥋</span>
                                                <div class="font-medium">هنرهای رزمی</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">قدرت عملکردی</div>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="flexibility" class="hidden">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">🤸</span>
                                                <div class="font-medium">انعطاف‌پذیری</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">یوگا و موبیلیتی</div>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="athletic" class="hidden">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">⚽</span>
                                                <div class="font-medium">عملکرد ورزشی</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">ورزش خاص</div>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="general_health" class="hidden">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">❤️</span>
                                                <div class="font-medium">سلامت کلی</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">تناسب اندام</div>
                                            </div>
                                        </label>
                                        <label class="option-card p-4 rounded-xl cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="radio" name="primaryGoal" value="rehabilitation" class="hidden">
                                            <div class="text-center">
                                                <span class="text-3xl mb-2 block">🩹</span>
                                                <div class="font-medium">بازتوانی</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">درمان و ترمیم</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">📅</span>
                                            برنامه زمانی *
                                        </h5>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-2">روزهای تمرین در هفته</label>
                                                <select id="trainingDays" class="w-full p-3 rounded-lg select-field" required="">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="2">2 روز در هفته</option>
                                                    <option value="3">3 روز در هفته</option>
                                                    <option value="4">4 روز در هفته</option>
                                                    <option value="5">5 روز در هفته</option>
                                                    <option value="6">6 روز در هفته</option>
                                                    <option value="7">روزانه</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">مدت هر جلسه (دقیقه)</label>
                                                <select id="sessionLength" class="w-full p-3 rounded-lg select-field" required="">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="20">20 دقیقه (سریع)</option>
                                                    <option value="30">30 دقیقه (کوتاه)</option>
                                                    <option value="45">45 دقیقه (متوسط)</option>
                                                    <option value="60">60 دقیقه (استاندارد)</option>
                                                    <option value="75">75 دقیقه (طولانی)</option>
                                                    <option value="90">90 دقیقه (کامل)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">زمان مطلوب تمرین</label>
                                                <select id="preferredTime" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="early_morning">صبح زود (5-7)</option>
                                                    <option value="morning">صبح (7-10)</option>
                                                    <option value="midday">ظهر (10-14)</option>
                                                    <option value="afternoon">بعدازظهر (14-18)</option>
                                                    <option value="evening">عصر (18-21)</option>
                                                    <option value="night">شب (21-23)</option>
                                                    <option value="flexible">انعطاف‌پذیر</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🎚️</span>
                                            اولویت‌بندی تمرینات
                                        </h5>
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm">تمرینات قدرتی:</span>
                                                <div class="flex items-center gap-2">
                                                    <input type="range" id="strengthPriority" min="0" max="10" value="5" class="w-20">
                                                    <span id="strengthValue" class="text-sm w-6 font-bold text-primary">5</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm">تمرینات هوازی:</span>
                                                <div class="flex items-center gap-2">
                                                    <input type="range" id="cardioPriority" min="0" max="10" value="5" class="w-20">
                                                    <span id="cardioValue" class="text-sm w-6 font-bold text-primary">5</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm">انعطاف‌پذیری:</span>
                                                <div class="flex items-center gap-2">
                                                    <input type="range" id="flexibilityPriority" min="0" max="10" value="5" class="w-20">
                                                    <span id="flexibilityValue" class="text-sm w-6 font-bold text-primary">5</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm">تعادل و ثبات:</span>
                                                <div class="flex items-center gap-2">
                                                    <input type="range" id="balancePriority" min="0" max="10" value="5" class="w-20">
                                                    <span id="balanceValue" class="text-sm w-6 font-bold text-primary">5</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Goal Analysis -->
                                <div id="goalAnalysis" class="hidden analysis-result">
                                    <h5 class="font-semibold text-primary mb-3 flex items-center">
                                        <span class="text-xl mr-2">🎯</span>
                                        تحلیل هدف انتخابی:
                                    </h5>
                                    <div id="goalAnalysisContent"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Equipment & Environment -->
                        <div id="step5" class="step hidden space-y-6">
                            <div class="text-center mb-8">
                                <h4 class="text-2xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">🏋️ تجهیزات و محیط</h4>
                                <p class="text-gray-600 dark:text-gray-400">امکانات موجود برای تمرین</p>
                            </div>

                            <div class="space-y-8">
                                <div class="metric-card p-6 rounded-2xl">
                                    <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                        <span class="text-xl mr-2">🏃</span>
                                        نوع تمرینات مورد علاقه *
                                    </h5>
                                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="weightlifting" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🏋️</span>
                                                <span class="text-sm">وزنه‌برداری</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="bodyweight" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🤸</span>
                                                <span class="text-sm">وزن بدن</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="cardio" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🏃</span>
                                                <span class="text-sm">هوازی</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="hiit" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">⚡</span>
                                                <span class="text-sm">HIIT</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="yoga" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🧘</span>
                                                <span class="text-sm">یوگا</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="pilates" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🏃‍♀️</span>
                                                <span class="text-sm">پیلاتس</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="swimming" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🏊</span>
                                                <span class="text-sm">شنا</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="running" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🏃‍♂️</span>
                                                <span class="text-sm">دویدن</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="cycling" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🚴</span>
                                                <span class="text-sm">دوچرخه</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="martial_arts" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">🥋</span>
                                                <span class="text-sm">رزمی</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="crossfit" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">💪</span>
                                                <span class="text-sm">کراس‌فیت</span>
                                            </div>
                                        </label>
                                        <label class="option-card p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="exerciseTypes" value="functional" class="hidden">
                                            <div class="text-center">
                                                <span class="text-2xl mb-1 block">⚖️</span>
                                                <span class="text-sm">عملکردی</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🎯</span>
                                            تجهیزات موجود *
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="full_gym" class="hidden">
                                                <div>
                                                    <div class="font-medium">باشگاه کامل</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تمام تجهیزات حرفه‌ای</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="home_gym" class="hidden">
                                                <div>
                                                    <div class="font-medium">سالن خانگی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تجهیزات شخصی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="dumbbells" class="hidden">
                                                <div>
                                                    <div class="font-medium">دمبل</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">وزن‌های قابل تنظیم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="barbell" class="hidden">
                                                <div>
                                                    <div class="font-medium">هالتر</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">میله‌ی المپیک</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="resistance_bands" class="hidden">
                                                <div>
                                                    <div class="font-medium">کش‌های مقاومتی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">انواع مقاومت</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="kettlebells" class="hidden">
                                                <div>
                                                    <div class="font-medium">کتل‌بل</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تمرینات عملکردی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="pull_up_bar" class="hidden">
                                                <div>
                                                    <div class="font-medium">بار بارفیکس</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">نصب درب یا دیوار</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="cardio_machine" class="hidden">
                                                <div>
                                                    <div class="font-medium">دستگاه هوازی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تردمیل، دوچرخه ثابت</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="equipment" value="bodyweight_only" class="hidden">
                                                <div>
                                                    <div class="font-medium">فقط وزن بدن</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">بدون هیچ تجهیزات</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🏠</span>
                                            محیط تمرین *
                                        </h5>
                                        <div class="space-y-3 mb-6">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="environment" value="gym" class="hidden" required="">
                                                <div>
                                                    <div class="font-medium">باشگاه</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">دسترسی آزاد به تجهیزات</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="environment" value="home" class="hidden">
                                                <div>
                                                    <div class="font-medium">خانه</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">راحتی و انعطاف‌پذیری</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="environment" value="outdoor" class="hidden">
                                                <div>
                                                    <div class="font-medium">فضای باز</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">پارک، خیابان، طبیعت</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="environment" value="mixed" class="hidden">
                                                <div>
                                                    <div class="font-medium">ترکیبی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">بسته به شرایط</div>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div>
                                            <h6 class="font-medium mb-3 text-amber-600">محدودیت‌های فضایی</h6>
                                            <div class="space-y-2">
                                                <label class="flex items-center option-card p-2 rounded-lg cursor-pointer border border-gray-200 dark:border-gray-600">
                                                    <input type="checkbox" name="spaceConstraints" value="noise" class="hidden">
                                                    <span class="text-sm">نمی‌توانم سر و صدا کنم</span>
                                                </label>
                                                <label class="flex items-center option-card p-2 rounded-lg cursor-pointer border border-gray-200 dark:border-gray-600">
                                                    <input type="checkbox" name="spaceConstraints" value="jumping" class="hidden">
                                                    <span class="text-sm">امکان پرش ندارم</span>
                                                </label>
                                                <label class="flex items-center option-card p-2 rounded-lg cursor-pointer border border-gray-200 dark:border-gray-600">
                                                    <input type="checkbox" name="spaceConstraints" value="limited_space" class="hidden">
                                                    <span class="text-sm">فضای محدود (کمتر از 2×2 متر)</span>
                                                </label>
                                                <label class="flex items-center option-card p-2 rounded-lg cursor-pointer border border-gray-200 dark:border-gray-600">
                                                    <input type="checkbox" name="spaceConstraints" value="low_ceiling" class="hidden">
                                                    <span class="text-sm">سقف کوتاه</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 6: Health & Medical -->
                        <div id="step6" class="step hidden space-y-6">
                            <div class="text-center mb-8">
                                <h4 class="text-2xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">🏥 سلامت و محدودیت‌ها</h4>
                                <p class="text-gray-600 dark:text-gray-400">اطلاعات پزشکی برای تمرین ایمن</p>
                            </div>

                            <div class="space-y-8">
                                <div class="metric-card p-6 rounded-2xl">
                                    <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                        <span class="text-xl mr-2">❤️</span>
                                        وضعیت سلامت کلی
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="healthConditions" value="none" class="hidden">
                                            <div>
                                                <div class="font-medium text-green-600">✅ سالم هستم</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">هیچ مشکل خاصی ندارم</div>
                                            </div>
                                        </label>
                                        <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="healthConditions" value="heart_disease" class="hidden">
                                            <div>
                                                <div class="font-medium text-red-600">❤️ مشکل قلبی</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">آریتمی، نارسایی قلب</div>
                                            </div>
                                        </label>
                                        <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="healthConditions" value="hypertension" class="hidden">
                                            <div>
                                                <div class="font-medium text-orange-600">📈 فشار خون بالا</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">هیپرتنشن</div>
                                            </div>
                                        </label>
                                        <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="healthConditions" value="diabetes" class="hidden">
                                            <div>
                                                <div class="font-medium text-blue-600">🩸 دیابت</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">نوع 1 یا 2</div>
                                            </div>
                                        </label>
                                        <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="healthConditions" value="asthma" class="hidden">
                                            <div>
                                                <div class="font-medium text-purple-600">🫁 آسم</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">مشکل تنفسی</div>
                                            </div>
                                        </label>
                                        <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="healthConditions" value="arthritis" class="hidden">
                                            <div>
                                                <div class="font-medium text-yellow-600">🦴 آرتریت</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">التهاب مفاصل</div>
                                            </div>
                                        </label>
                                        <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="healthConditions" value="thyroid" class="hidden">
                                            <div>
                                                <div class="font-medium text-indigo-600">🧬 مشکل تیروئید</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">کم‌کاری یا پرکاری</div>
                                            </div>
                                        </label>
                                        <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" name="healthConditions" value="other" class="hidden">
                                            <div>
                                                <div class="font-medium text-gray-600">❓ سایر موارد</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">در قسمت توضیحات بنویسید</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🩹</span>
                                            آسیب‌ها و درد
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="injuries" value="none" class="hidden">
                                                <div>
                                                    <div class="font-medium text-green-600">✅ بدون آسیب</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">هیچ درد یا مشکلی ندارم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="injuries" value="back_pain" class="hidden">
                                                <div>
                                                    <div class="font-medium text-red-600">🔴 درد کمر</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">مزمن یا گاه‌به‌گاه</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="injuries" value="neck_pain" class="hidden">
                                                <div>
                                                    <div class="font-medium text-orange-600">🟠 درد گردن</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کار طولانی پشت میز</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="injuries" value="knee_pain" class="hidden">
                                                <div>
                                                    <div class="font-medium text-blue-600">🔵 درد زانو</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">آسیب قدیمی یا فعلی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="injuries" value="shoulder_pain" class="hidden">
                                                <div>
                                                    <div class="font-medium text-purple-600">🟣 درد شانه</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">محدودیت حرکتی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="injuries" value="wrist_pain" class="hidden">
                                                <div>
                                                    <div class="font-medium text-yellow-600">🟡 درد مچ دست</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کارپال تونل یا التهاب</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="injuries" value="ankle_pain" class="hidden">
                                                <div>
                                                    <div class="font-medium text-pink-600">🩷 درد مچ پا</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">پیچ خوردگی قدیمی</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🚶</span>
                                            سطح فعالیت روزانه
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="dailyActivity" value="sedentary" class="hidden">
                                                <div>
                                                    <div class="font-medium">🪑 نشسته</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کار اداری، بیش از 8 ساعت نشستن</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="dailyActivity" value="light" class="hidden">
                                                <div>
                                                    <div class="font-medium">🚶 فعالیت سبک</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">گاهی راه رفتن، کارهای خانه</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="dailyActivity" value="moderate" class="hidden">
                                                <div>
                                                    <div class="font-medium">🚴 فعالیت متوسط</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کار ایستاده، جابه‌جایی زیاد</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="dailyActivity" value="active" class="hidden">
                                                <div>
                                                    <div class="font-medium">🏃 فعال</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کار فیزیکی، حرکت مداوم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="dailyActivity" value="very_active" class="hidden">
                                                <div>
                                                    <div class="font-medium">💪 بسیار فعال</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">کار سنگین فیزیکی</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="metric-card p-6 rounded-2xl">
                                    <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                        <span class="text-xl mr-2">💊</span>
                                        اطلاعات تکمیلی
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">دارو یا مکمل‌های فعلی</label>
                                            <textarea id="medications" class="w-full p-3 rounded-lg input-field" rows="3" placeholder="مثال: ویتامین دی، اومگا 3، قرص فشار خون..."></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">تاریخچه جراحی یا آسیب مهم</label>
                                            <textarea id="medicalHistory" class="w-full p-3 rounded-lg input-field" rows="3" placeholder="مثال: عمل زانو در سال گذشته، شکستگی مچ دست..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 7: Lifestyle -->
                        <div id="step7" class="step hidden space-y-6">
                            <div class="text-center mb-8">
                                <h4 class="text-2xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">🌱 سبک زندگی</h4>
                                <p class="text-gray-600 dark:text-gray-400">عادات روزانه تأثیرگذار بر نتایج</p>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="space-y-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">😴</span>
                                            الگوی خواب
                                        </h5>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-2">ساعات خواب شبانه</label>
                                                <select id="sleepHours" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="less_5">کمتر از 5 ساعت</option>
                                                    <option value="5_6">5-6 ساعت</option>
                                                    <option value="6_7">6-7 ساعت</option>
                                                    <option value="7_8">7-8 ساعت</option>
                                                    <option value="8_9">8-9 ساعت</option>
                                                    <option value="more_9">بیش از 9 ساعت</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">کیفیت خواب</label>
                                                <select id="sleepQuality" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="poor">ضعیف (مکرر بیدار می‌شوم)</option>
                                                    <option value="fair">متوسط (گاهی مشکل دارم)</option>
                                                    <option value="good">خوب (معمولاً راحت می‌خوابم)</option>
                                                    <option value="excellent">عالی (عمیق و بدون وقفه)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">زمان خواب معمولی</label>
                                                <select id="bedTime" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="early">زود (21-22)</option>
                                                    <option value="normal">متوسط (22-23)</option>
                                                    <option value="late">دیر (23-24)</option>
                                                    <option value="very_late">خیلی دیر (بعد از 24)</option>
                                                    <option value="irregular">نامنظم</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🧠</span>
                                            استرس و انرژی
                                        </h5>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-2">میزان استرس روزانه</label>
                                                <select id="stressLevel" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="very_low">خیلی کم (آرام و راحت)</option>
                                                    <option value="low">کم (استرس معمولی)</option>
                                                    <option value="moderate">متوسط (فشار کاری)</option>
                                                    <option value="high">زیاد (استرس مداوم)</option>
                                                    <option value="very_high">خیلی زیاد (بحرانی)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">سطح انرژی معمولی</label>
                                                <select id="energyLevel" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="very_low">خیلی کم (همیشه خسته)</option>
                                                    <option value="low">کم (اکثر اوقات کسل)</option>
                                                    <option value="moderate">متوسط (نرمال)</option>
                                                    <option value="high">زیاد (پرانرژی)</option>
                                                    <option value="very_high">خیلی زیاد (شاداب)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">بهترین زمان انرژی</label>
                                                <select id="energyPeak" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="morning">صبح (6-12)</option>
                                                    <option value="afternoon">بعدازظهر (12-18)</option>
                                                    <option value="evening">عصر (18-21)</option>
                                                    <option value="night">شب (21-24)</option>
                                                    <option value="variable">متغیر</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🍽️</span>
                                            عادات غذایی
                                        </h5>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-2">تعداد وعده‌های غذایی</label>
                                                <select id="mealsPerDay" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="1">1 وعده (OMAD)</option>
                                                    <option value="2">2 وعده (صبحانه + نهار یا شام)</option>
                                                    <option value="3">3 وعده (استاندارد)</option>
                                                    <option value="4">4 وعده (+ یک میان‌وعده)</option>
                                                    <option value="5">5 وعده (+ دو میان‌وعده)</option>
                                                    <option value="6">6 وعده (وعده‌های کوچک)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">میزان مصرف آب (لیتر در روز)</label>
                                                <input type="number" id="waterIntake" class="w-full p-3 rounded-lg input-field" placeholder="مثال: 2.5" min="0.5" max="6" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">رژیم غذایی خاص</label>
                                                <select id="dietType" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">ندارم</option>
                                                    <option value="vegetarian">گیاه‌خوار</option>
                                                    <option value="vegan">وگان</option>
                                                    <option value="keto">کتوژنیک</option>
                                                    <option value="low_carb">کم کربوهیدرات</option>
                                                    <option value="mediterranean">مدیترانه‌ای</option>
                                                    <option value="intermittent">روزه متناوب</option>
                                                    <option value="paleo">پالئو</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">سرعت خوردن غذا</label>
                                                <select id="eatingSpeed" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="very_fast">خیلی سریع (عجله‌ای)</option>
                                                    <option value="fast">سریع</option>
                                                    <option value="normal">متوسط</option>
                                                    <option value="slow">آهسته (مدیتیو)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">⏰</span>
                                            محدودیت‌های زمانی
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="timeConstraints" value="early_morning" class="hidden">
                                                <div>
                                                    <div class="font-medium">فقط صبح زود وقت دارم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">قبل از شروع کار</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="timeConstraints" value="irregular_schedule" class="hidden">
                                                <div>
                                                    <div class="font-medium">برنامه نامنظم دارم</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">ساعات کار متغیر</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="timeConstraints" value="shift_work" class="hidden">
                                                <div>
                                                    <div class="font-medium">کار شیفتی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">شب‌کاری یا شیفت در گردش</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="timeConstraints" value="family_commitments" class="hidden">
                                                <div>
                                                    <div class="font-medium">تعهدات خانوادگی زیاد</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">مراقبت از فرزند، والدین</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="timeConstraints" value="long_commute" class="hidden">
                                                <div>
                                                    <div class="font-medium">مسیر طولانی کار</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">بیش از ساعت در روز</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="timeConstraints" value="weekend_only" class="hidden">
                                                <div>
                                                    <div class="font-medium">فقط آخر هفته</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">هفته کاری پرمشغله</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Final Analysis Display -->
                            <div id="finalAnalysis" class="hidden analysis-result">
                                <h5 class="font-semibold text-primary mb-3 flex items-center">
                                    <span class="text-xl mr-2">🧠</span>
                                    پیش‌نمایش تحلیل نهایی:
                                </h5>
                                <div id="analysisPreview"></div>
                            </div>
                        </div>

                        <!-- Step 8: Motivation & Psychology -->
                        <div id="step8" class="step hidden space-y-6">
                            <div class="text-center mb-8">
                                <h4 class="text-2xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">🧠 انگیزه و روانشناسی</h4>
                                <p class="text-gray-600 dark:text-gray-400">عوامل ذهنی موثر بر موفقیت</p>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="space-y-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">💡</span>
                                            انگیزه اصلی
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="motivation" value="health" class="hidden">
                                                <div>
                                                    <div class="font-medium">سلامتی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">بهبود سلامت جسمی و روحی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="motivation" value="appearance" class="hidden">
                                                <div>
                                                    <div class="font-medium">ظاهر</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">بهبود شکل ظاهری بدن</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="motivation" value="performance" class="hidden">
                                                <div>
                                                    <div class="font-medium">عملکرد</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">بهبود قدرت و توانایی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="motivation" value="confidence" class="hidden">
                                                <div>
                                                    <div class="font-medium">اعتماد به نفس</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">احساس بهتر در مورد خودم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="motivation" value="medical" class="hidden">
                                                <div>
                                                    <div class="font-medium">پزشکی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">توصیه پزشک</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="motivation" value="social" class="hidden">
                                                <div>
                                                    <div class="font-medium">اجتماعی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">فعالیت با دوستان</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🎯</span>
                                            نوع شخصیت ورزشی
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="personality" value="competitor" class="hidden">
                                                <div>
                                                    <div class="font-medium">رقابتی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">دوست دارم رکورد بزنم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="personality" value="social" class="hidden">
                                                <div>
                                                    <div class="font-medium">اجتماعی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">با دیگران بهتر تمرین می‌کنم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="personality" value="individual" class="hidden">
                                                <div>
                                                    <div class="font-medium">انفرادی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تنها بهتر تمرین می‌کنم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="personality" value="routine" class="hidden">
                                                <div>
                                                    <div class="font-medium">برنامه‌ای</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">نیاز به ساختار مشخص دارم</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="radio" name="personality" value="flexible" class="hidden">
                                                <div>
                                                    <div class="font-medium">انعطاف‌پذیر</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">دوست دارم تنوع داشته باشم</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-6">
                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">📈</span>
                                            سابقه موفقیت/شکست
                                        </h5>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium mb-2">تجربه قبلی با ورزش</label>
                                                <select id="pastExperience" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="never_tried">هرگز امتحان نکردم</option>
                                                    <option value="failed_multiple">چندبار شروع کردم ولی موفق نشدم</option>
                                                    <option value="some_success">گاهی موفق بودم</option>
                                                    <option value="mostly_successful">بیشتر اوقات موفق بودم</option>
                                                    <option value="always_successful">همیشه به اهدافم رسیدم</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">بزرگترین مانع قبلی</label>
                                                <select id="biggestBarrier" class="w-full p-3 rounded-lg select-field">
                                                    <option value="">انتخاب کنید</option>
                                                    <option value="time">کمبود وقت</option>
                                                    <option value="motivation">کمبود انگیزه</option>
                                                    <option value="knowledge">نداشتن اطلاعات کافی</option>
                                                    <option value="injury">آسیب یا درد</option>
                                                    <option value="boredom">خسته‌کننده بودن</option>
                                                    <option value="results">نبودن نتیجه سریع</option>
                                                    <option value="social">کمبود حمایت اجتماعی</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-2">درجه تعهد فعلی (1-10)</label>
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm">1</span>
                                                    <input type="range" id="commitment" min="1" max="10" value="5" class="flex-1">
                                                    <span class="text-sm">10</span>
                                                    <span id="commitmentValue" class="text-lg font-bold text-primary w-8">5</span>
                                                </div>
                                                <div class="text-xs text-gray-500 mt-1">1: شاید امتحان کنم | 10: کاملاً متعهدم</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="metric-card p-6 rounded-2xl">
                                        <h5 class="font-semibold text-lg mb-4 text-primary flex items-center">
                                            <span class="text-xl mr-2">🏆</span>
                                            ترجیحات تشویق
                                        </h5>
                                        <div class="space-y-3">
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="rewards" value="visual_progress" class="hidden">
                                                <div>
                                                    <div class="font-medium">دیدن پیشرفت</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">نمودار، عکس، اندازه‌گیری</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="rewards" value="achievement_badges" class="hidden">
                                                <div>
                                                    <div class="font-medium">مدال و نشان</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">دستاورد و رکورد شخصی</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="rewards" value="social_recognition" class="hidden">
                                                <div>
                                                    <div class="font-medium">تقدیر اجتماعی</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">تشویق دوستان و خانواده</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="rewards" value="tangible_rewards" class="hidden">
                                                <div>
                                                    <div class="font-medium">جایزه محسوس</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">لباس جدید، مکمل، تجهیزات</div>
                                                </div>
                                            </label>
                                            <label class="option-card flex items-center p-3 rounded-lg cursor-pointer border-2 border-gray-200 dark:border-gray-600">
                                                <input type="checkbox" name="rewards" value="feeling_good" class="hidden">
                                                <div>
                                                    <div class="font-medium">احساس خوب</div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">انرژی، اعتماد به نفس، شادی</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Final Summary -->
                            <div class="analysis-result">
                                <h5 class="font-semibold text-primary mb-4 flex items-center">
                                    <span class="text-xl mr-2">✅</span>
                                    خلاصه تحلیل جامع - آماده برای تولید برنامه اختصاصی
                                </h5>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-center">
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="font-bold text-primary">هوش مصنوعی</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">تحلیل 50+ پارامتر</div>
                                    </div>
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="font-bold text-green-600">شخصی‌سازی</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">منحصر به فرد شما</div>
                                    </div>
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="font-bold text-blue-600">علمی</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">مبتنی بر آخرین تحقیقات</div>
                                    </div>
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="font-bold text-purple-600">جامع</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">تمرین + تغذیه + ریکاوری</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-between items-center mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
                            <button id="prevBtn" class="hidden bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                                ← مرحله قبل
                            </button>
                            <div class="flex-1"></div>
                            <button id="nextBtn" class="gradient-primary text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105">
                                مرحله بعد →
                            </button>
                            <button id="generateBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-12 py-4 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl animate-bounce-soft">
                                🚀 تولید برنامه هوشمند
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Dashboard -->
            <div id="resultsDashboard" class="hidden animate-fade-in">
                <!-- Results will be dynamically generated here -->
            </div>
        </main>
    </div>

    <script>
        // Scientific Analysis Engine - Real Intelligence
        class AdvancedScientificEngine {
            constructor() {
                this.userData = {};
                this.analysisResults = {};
                this.scientificConstants = {
                    BMR_MALE: { base: 10, weight: 6.25, height: 5, age: 5 },
                    BMR_FEMALE: { base: 10, weight: 6.25, height: 5, age: 161 },
                    ACTIVITY_FACTORS: {
                        sedentary: 1.2,
                        light: 1.375,
                        moderate: 1.55,
                        active: 1.725,
                        very_active: 1.9
                    },
                    FITNESS_NORMS: {
                        pushup: {
                            male: { excellent: 39, good: 30, average: 22, below: 17 },
                            female: { excellent: 20, good: 15, average: 10, below: 7 }
                        },
                        plank: { excellent: 120, good: 90, average: 60, below: 30 }
                    }
                };
            }

            // Advanced BMI calculation with WHO categories
            calculateAdvancedBMI(weight, height, age, gender) {
                const bmi = weight / Math.pow(height / 100, 2);
                let category, risk, recommendation;
                
                // Age-adjusted BMI categories
                const ageAdjustment = age > 65 ? 1 : 0;
                const adjustedBMI = bmi + ageAdjustment;
                
                if (adjustedBMI < 16) {
                    category = 'کم‌وزن شدید';
                    risk = 'بسیار بالا';
                    recommendation = 'مراجعه فوری به پزشک';
                } else if (adjustedBMI < 17) {
                    category = 'کم‌وزن متوسط';
                    risk = 'بالا';
                    recommendation = 'افزایش وزن تدریجی';
                } else if (adjustedBMI < 18.5) {
                    category = 'کم‌وزن خفیف';
                    risk = 'متوسط';
                    recommendation = 'تقویت عضلات';
                } else if (adjustedBMI < 25) {
                    category = 'طبیعی';
                    risk = 'کم';
                    recommendation = 'حفظ وضعیت فعلی';
                } else if (adjustedBMI < 30) {
                    category = 'اضافه‌وزن';
                    risk = 'متوسط';
                    recommendation = 'کاهش تدریجی وزن';
                } else if (adjustedBMI < 35) {
                    category = 'چاقی درجه 1';
                    risk = 'بالا';
                    recommendation = 'برنامه کاهش وزن جدی';
                } else if (adjustedBMI < 40) {
                    category = 'چاقی درجه 2';
                    risk = 'خیلی بالا';
                    recommendation = 'مداخله پزشکی ضروری';
                } else {
                    category = 'چاقی درجه 3';
                    risk = 'بحرانی';
                    recommendation = 'مداخله فوری پزشکی';
                }

                return { 
                    bmi: bmi.toFixed(1), 
                    adjustedBMI: adjustedBMI.toFixed(1),
                    category, 
                    risk, 
                    recommendation 
                };
            }

            // Precision BMR calculation (Mifflin-St Jeor + Harris-Benedict comparison)
            calculatePrecisionBMR(weight, height, age, gender) {
                // Mifflin-St Jeor (more accurate)
                let mifflinBMR;
                if (gender === 'male') {
                    mifflinBMR = (10 * weight) + (6.25 * height) - (5 * age) + 5;
                } else {
                    mifflinBMR = (10 * weight) + (6.25 * height) - (5 * age) - 161;
                }

                // Harris-Benedict (for comparison)
                let harrisBMR;
                if (gender === 'male') {
                    harrisBMR = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
                } else {
                    harrisBMR = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
                }

                // Use Mifflin as primary, Harris as validation
                const avgBMR = (mifflinBMR + harrisBMR) / 2;
                const accuracy = 100 - Math.abs(mifflinBMR - harrisBMR) / mifflinBMR * 100;

                return {
                    bmr: Math.round(mifflinBMR),
                    alternativeBMR: Math.round(harrisBMR),
                    averageBMR: Math.round(avgBMR),
                    accuracy: accuracy.toFixed(1)
                };
            }

            // Advanced TDEE with activity and metabolic corrections
            calculateAdvancedTDEE(bmr, activityLevel, age, bodyFat = null, muscleMass = null) {
                let baseTDEE = bmr * this.scientificConstants.ACTIVITY_FACTORS[activityLevel];
                
                // Age correction (metabolism slows with age)
                const ageCorrection = age > 30 ? 1 - ((age - 30) * 0.01) : 1;
                
                // Body composition correction
                let compositionCorrection = 1;
                if (bodyFat) {
                    // Higher muscle mass = higher metabolism
                    const leanBodyMass = 100 - bodyFat;
                    compositionCorrection = 0.8 + (leanBodyMass / 100) * 0.4;
                }
                
                const correctedTDEE = baseTDEE * ageCorrection * compositionCorrection;
                
                return {
                    baseTDEE: Math.round(baseTDEE),
                    correctedTDEE: Math.round(correctedTDEE),
                    ageCorrection: ageCorrection.toFixed(3),
                    compositionCorrection: compositionCorrection.toFixed(3)
                };
            }

            // Scientific body fat estimation (multiple methods)
            estimateBodyFat(bmi, age, gender, waist = null, neck = null, hip = null) {
                // Method 1: BMI-based estimation (Deurenberg et al.)
                let deurenbergBF;
                if (gender === 'male') {
                    deurenbergBF = (1.20 * bmi) + (0.23 * age) - 16.2;
                } else {
                    deurenbergBF = (1.20 * bmi) + (0.23 * age) - 5.4;
                }

                // Method 2: US Navy formula (if measurements available)
                let navyBF = null;
                if (waist && neck && (gender === 'male' || hip)) {
                    if (gender === 'male') {
                        navyBF = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.15456 * Math.log10(height)) - 450;
                    } else {
                        navyBF = 495 / (1.29579 - 0.35004 * Math.log10(waist + hip - neck) + 0.22100 * Math.log10(height)) - 450;
                    }
                }

                // Age and gender adjustments
                const minBF = gender === 'male' ? 3 : 8;
                const maxBF = gender === 'male' ? 35 : 45;
                
                const estimatedBF = Math.max(minBF, Math.min(maxBF, deurenbergBF));
                
                return {
                    estimated: estimatedBF.toFixed(1),
                    navy: navyBF ? navyBF.toFixed(1) : null,
                    method: navyBF ? 'Navy + Deurenberg' : 'Deurenberg',
                    confidence: navyBF ? 'High' : 'Medium'
                };
            }

            // Advanced somatotype determination (Heath-Carter method)
            calculateSomatotype(userData) {
                let endomorphy = 0;
                let mesomorphy = 0;
                let ectomorphy = 0;

                // Weight pattern analysis (40% weight)
                const weightPatternScores = {
                    'gain_very_easy': { endo: 3, meso: 0, ecto: 0 },
                    'gain_easy': { endo: 2, meso: 1, ecto: 0 },
                    'stable': { endo: 1, meso: 2, ecto: 1 },
                    'lose_easy': { endo: 0, meso: 1, ecto: 2 },
                    'lose_very_hard': { endo: 3, meso: 0, ecto: 0 }
                };

                const weightScore = weightPatternScores[userData.weightPattern] || { endo: 1, meso: 1, ecto: 1 };
                endomorphy += weightScore.endo * 0.4;
                mesomorphy += weightScore.meso * 0.4;
                ectomorphy += weightScore.ecto * 0.4;

                // Frame size analysis (25% weight)
                const frameScores = {
                    'small': { endo: 0, meso: 0, ecto: 2 },
                    'medium': { endo: 1, meso: 2, ecto: 1 },
                    'large': { endo: 2, meso: 1, ecto: 0 }
                };

                const frameScore = frameScores[userData.frameSize] || { endo: 1, meso: 1, ecto: 1 };
                endomorphy += frameScore.endo * 0.25;
                mesomorphy += frameScore.meso * 0.25;
                ectomorphy += frameScore.ecto * 0.25;

                // Muscle gain ability (20% weight)
                const muscleScores = {
                    'very_easy': { endo: 1, meso: 3, ecto: 0 },
                    'easy': { endo: 1, meso: 2, ecto: 0 },
                    'moderate': { endo: 1, meso: 1, ecto: 1 },
                    'hard': { endo: 0, meso: 0, ecto: 2 }
                };

                const muscleScore = muscleScores[userData.muscleGain] || { endo: 1, meso: 1, ecto: 1 };
                endomorphy += muscleScore.endo * 0.2;
                mesomorphy += muscleScore.meso * 0.2;
                ectomorphy += muscleScore.ecto * 0.2;

                // Appetite pattern (15% weight)
                const appetiteScores = {
                    'always_hungry': { endo: 2, meso: 1, ecto: 0 },
                    'normal': { endo: 1, meso: 1, ecto: 1 },
                    'low': { endo: 0, meso: 0, ecto: 2 },
                    'very_low': { endo: 0, meso: 0, ecto: 3 }
                };

                const appetiteScore = appetiteScores[userData.appetitePattern] || { endo: 1, meso: 1, ecto: 1 };
                endomorphy += appetiteScore.endo * 0.15;
                mesomorphy += appetiteScore.meso * 0.15;
                ectomorphy += appetiteScore.ecto * 0.15;

                // Determine dominant type
                const scores = { endomorphy, mesomorphy, ectomorphy };
                const dominantType = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
                
                // Calculate secondary type
                const sortedTypes = Object.entries(scores).sort(([,a], [,b]) => b - a);
                const secondaryType = sortedTypes[1][0];
                const dominantScore = sortedTypes[0][1];
                const secondaryScore = sortedTypes[1][1];
                
                // Determine if pure type or combination
                const scoreDifference = dominantScore - secondaryScore;
                const isPure = scoreDifference > 1;

                const somatotypes = {
                    endomorphy: {
                        name: 'اندومورف',
                        description: 'طبیعت شما به ذخیره انرژی و چربی تمایل دارد. متابولیسم کندتر و استعداد عضله‌سازی متوسط.',
                        characteristics: [
                            'ذخیره آسان چربی و انرژی',
                            'متابولیسم پایه کندتر',
                            'نیاز به کنترل دقیق‌تر کالری',
                            'پاسخ عالی به تمرینات قدرتی',
                            'احتیاج بیشتر به تمرینات هوازی'
                        ],
                        advantages: [
                            'عضله‌سازی نسبتاً آسان',
                            'قدرت طبیعی بالا',
                            'ریکاوری سریع بین تمرینات'
                        ],
                        challenges: [
                            'کاهش چربی سخت‌تر',
                            'نیاز به رژیم غذایی دقیق‌تر',
                            'حساسیت بالا به کربوهیدرات'
                        ],
                        recommendations: {
                            training: [
                                'ترکیب تمرینات قدرتی و هوازی',
                                'تمرینات HIIT برای سوزاندن چربی',
                                'تمرینات کل بدن',
                                'کاهش استراحت بین ست‌ها'
                            ],
                            nutrition: [
                                'کنترل کالری دقیق',
                                'کاهش کربوهیدرات ساده',
                                'افزایش پروتئین (2.2-2.5g/kg)',
                                'تایمینگ کربوهیدرات حول تمرین'
                            ]
                        }
                    },
                    mesomorphy: {
                        name: 'مزومورف',
                        description: 'شما طبیعتاً عضلانی و متعادل هستید. متابولیسم مناسب و استعداد بالای عضله‌سازی.',
                        characteristics: [
                            'عضله‌سازی آسان و سریع',
                            'متابولیسم متعادل و مناسب',
                            'پاسخ سریع به تمرینات',
                            'ترکیب بدنی طبیعی مناسب',
                            'انعطاف‌پذیری در رژیم غذایی'
                        ],
                        advantages: [
                            'نتایج سریع از تمرینات',
                            'تعادل طبیعی چربی-عضله',
                            'متابولیسم کارآمد'
                        ],
                        challenges: [
                            'ممکن است اهداف را دست کم بگیرد',
                            'نیاز به چالش مداوم',
                            'خطر کم‌کاری در رژیم'
                        ],
                        recommendations: {
                            training: [
                                'تمرینات ترکیبی و متنوع',
                                'توازن بین قدرت و هوازی',
                                'تمرینات پیشرفته و چالشی',
                                'تغییر برنامه هر 4-6 هفته'
                            ],
                            nutrition: [
                                'رژیم متعادل ماکرونوترینت',
                                'پروتئین متوسط (1.8-2.2g/kg)',
                                'کربوهیدرات مناسب برای انرژی',
                                'چربی‌های سالم کافی'
                            ]
                        }
                    },
                    ectomorphy: {
                        name: 'اکتومورف',
                        description: 'شما طبیعتاً لاغر با متابولیسم بالا هستید. سخت وزن اضافه می‌کنید اما چربی کم ذخیره می‌شود.',
                        characteristics: [
                            'متابولیسم بسیار سریع',
                            'دشواری در وزن‌گیری',
                            'درصد چربی طبیعتاً کم',
                            'اندام‌های باریک و طولانی',
                            'انرژی زیاد و بی‌قراری'
                        ],
                        advantages: [
                            'هیچ‌وقت چاق نمی‌شود',
                            'تعریف عضلانی عالی',
                            'ریکاوری سریع',
                            'استقامت طبیعی بالا'
                        ],
                        challenges: [
                            'عضله‌سازی بسیار سخت',
                            'نیاز به کالری بسیار زیاد',
                            'حساسیت به حجم تمرین زیاد'
                        ],
                        recommendations: {
                            training: [
                                'تمرینات قدرتی سنگین',
                                'محدود کردن کاردیو',
                                'استراحت طولانی بین ست‌ها',
                                'تمرکز بر حرکات کامپوند'
                            ],
                            nutrition: [
                                'کالری بسیار بالا',
                                'کربوهیدرات زیاد (50-60%)',
                                'پروتئین کافی (2-2.5g/kg)',
                                'وعده‌های مکرر و پرکالری'
                            ]
                        }
                    }
                };

                return {
                    ...somatotypes[dominantType],
                    scores: {
                        endomorphy: endomorphy.toFixed(1),
                        mesomorphy: mesomorphy.toFixed(1),
                        ectomorphy: ectomorphy.toFixed(1)
                    },
                    dominantType: dominantType,
                    secondaryType: isPure ? null : secondaryType,
                    isPure: isPure,
                    confidence: scoreDifference > 2 ? 'High' : scoreDifference > 1 ? 'Medium' : 'Low'
                };
            }

            // Advanced fitness assessment with age/gender norms
            assessAdvancedFitness(userData) {
                const age = parseInt(userData.age);
                const gender = userData.gender;
                let totalScore = 0;
                let maxScore = 0;
                let components = {};

                // Strength assessment (Push-ups)
                const pushups = parseInt(userData.pushupMax) || 0;
                let pushupScore = 0;
                const pushupNorms = this.scientificConstants.FITNESS_NORMS.pushup[gender];
                
                if (pushups >= pushupNorms.excellent) pushupScore = 5;
                else if (pushups >= pushupNorms.good) pushupScore = 4;
                else if (pushups >= pushupNorms.average) pushupScore = 3;
                else if (pushups >= pushupNorms.below) pushupScore = 2;
                else if (pushups > 0) pushupScore = 1;

                components.strength = pushupScore;
                totalScore += pushupScore;
                maxScore += 5;

                // Core stability (Plank)
                const plankTime = parseInt(userData.plankTime) || 0;
                let plankScore = 0;
                const plankNorms = this.scientificConstants.FITNESS_NORMS.plank;
                
                if (plankTime >= plankNorms.excellent) plankScore = 5;
                else if (plankTime >= plankNorms.good) plankScore = 4;
                else if (plankTime >= plankNorms.average) plankScore = 3;
                else if (plankTime >= plankNorms.below) plankScore = 2;
                else if (plankTime > 0) plankScore = 1;

                components.core = plankScore;
                totalScore += plankScore;
                maxScore += 5;

                // Cardiovascular endurance
                const runningTime = parseInt(userData.runningTime) || 0;
                let cardioScore = 0;
                
                // Age-adjusted cardio norms
                const expectedRunning = age < 30 ? 25 : age < 40 ? 20 : age < 50 ? 15 : 10;
                
                if (runningTime >= expectedRunning * 1.5) cardioScore = 5;
                else if (runningTime >= expectedRunning * 1.2) cardioScore = 4;
                else if (runningTime >= expectedRunning) cardioScore = 3;
                else if (runningTime >= expectedRunning * 0.7) cardioScore = 2;
                else if (runningTime > 0) cardioScore = 1;

                components.cardio = cardioScore;
                totalScore += cardioScore;
                maxScore += 5;

                // Flexibility assessment
                const flexibilityScores = {
                    'excellent': 5,
                    'good': 4,
                    'fair': 3,
                    'poor': 2
                };
                const flexibilityScore = flexibilityScores[userData.flexibility] || 0;
                components.flexibility = flexibilityScore;
                totalScore += flexibilityScore;
                maxScore += 5;

                // Experience factor
                const experienceScores = {
                    'expert': 5,
                    'advanced': 4,
                    'intermediate': 3,
                    'beginner': 2,
                    'none': 1
                };
                const experienceScore = experienceScores[userData.experience] || 1;
                components.experience = experienceScore;
                totalScore += experienceScore;
                maxScore += 5;

                // Heart rate analysis (if available)
                let hrScore = 3; // default
                const restingHR = parseInt(userData.restingHR);
                if (restingHR) {
                    const excellentHR = gender === 'male' ? 55 : 60;
                    const goodHR = gender === 'male' ? 65 : 70;
                    const avgHR = gender === 'male' ? 75 : 80;
                    
                    if (restingHR <= excellentHR) hrScore = 5;
                    else if (restingHR <= goodHR) hrScore = 4;
                    else if (restingHR <= avgHR) hrScore = 3;
                    else if (restingHR <= avgHR + 10) hrScore = 2;
                    else hrScore = 1;
                }
                components.heartRate = hrScore;
                totalScore += hrScore;
                maxScore += 5;

                const percentage = (totalScore / maxScore) * 100;
                
                // Determine fitness level with more nuanced categories
                let level, description, nextSteps;
                if (percentage >= 90) {
                    level = 'ورزشکار';
                    description = 'آمادگی ورزشکاری. می‌توانید تمرینات پیشرفته و رقابتی انجام دهید.';
                    nextSteps = ['حفظ سطح فعلی', 'تمرینات تخصصی', 'رقابت‌های ورزشی'];
                } else if (percentage >= 80) {
                    level = 'پیشرفته';
                    description = 'آمادگی عالی. برای تمرینات پیچیده و پرشدت آماده هستید.';
                    nextSteps = ['افزایش شدت', 'تمرینات ترکیبی', 'اهداف چالشی'];
                } else if (percentage >= 65) {
                    level = 'متوسط بالا';
                    description = 'آمادگی خوب. می‌توانید تمرینات متوسط تا سخت انجام دهید.';
                    nextSteps = ['گسترش برنامه', 'افزایش تنوع', 'تمرینات قدرتی'];
                } else if (percentage >= 50) {
                    level = 'متوسط';
                    description = 'آمادگی پایه مناسب. برای تمرینات متوسط آماده هستید.';
                    nextSteps = ['ثبات در برنامه', 'افزایش تدریجی حجم', 'تمرکز بر ضعف‌ها'];
                } else if (percentage >= 35) {
                    level = 'مبتدی';
                    description = 'شروع خوب. با تمرینات ساده و تدریجی پیش بروید.';
                    nextSteps = ['ایجاد عادت', 'تمرینات پایه', 'افزایش تدریجی'];
                } else {
                    level = 'تازه‌کار';
                    description = 'نیاز به شروع بسیار تدریجی. تمرکز بر ایجاد عادت و فرم صحیح.';
                    nextSteps = ['شروع بسیار آهسته', 'تمرکز بر تکنیک', 'صبر و استقامت'];
                }

                return {
                    totalScore,
                    maxScore,
                    percentage: Math.round(percentage),
                    level,
                    description,
                    nextSteps,
                    components,
                    weakestArea: Object.keys(components).reduce((a, b) => 
                        components[a] < components[b] ? a : b
                    ),
                    strongestArea: Object.keys(components).reduce((a, b) => 
                        components[a] > components[b] ? a : b
                    )
                };
            }

            // Complete metabolic analysis
            performMetabolicAnalysis(userData) {
                const weight = parseFloat(userData.weight);
                const height = parseFloat(userData.height);
                const age = parseInt(userData.age);
                const gender = userData.gender;
                const bodyFat = userData.bodyFat ? parseFloat(userData.bodyFat) : null;

                // BMI Analysis
                const bmiData = this.calculateAdvancedBMI(weight, height, age, gender);
                
                // BMR Analysis
                const bmrData = this.calculatePrecisionBMR(weight, height, age, gender);
                
                // TDEE Analysis
                const tdeeData = this.calculateAdvancedTDEE(
                    bmrData.bmr, 
                    userData.dailyActivity, 
                    age, 
                    bodyFat
                );
                
                // Body Fat Analysis
                const bodyFatData = this.estimateBodyFat(parseFloat(bmiData.bmi), age, gender);
                
                // Lean Body Mass
                const estimatedBF = bodyFat || parseFloat(bodyFatData.estimated);
                const leanBodyMass = weight * (1 - estimatedBF / 100);
                const fatMass = weight - leanBodyMass;
                
                // Metabolic flexibility assessment
                const metabolicFactors = {
                    age: age < 30 ? 'High' : age < 45 ? 'Medium' : 'Low',
                    bodyComp: estimatedBF < 15 ? 'High' : estimatedBF < 25 ? 'Medium' : 'Low',
                    activity: ['active', 'very_active'].includes(userData.dailyActivity) ? 'High' : 'Medium'
                };

                return {
                    bmi: bmiData,
                    bmr: bmrData,
                    tdee: tdeeData,
                    bodyFat: bodyFatData,
                    bodyComposition: {
                        totalWeight: weight,
                        leanBodyMass: leanBodyMass.toFixed(1),
                        fatMass: fatMass.toFixed(1),
                        bodyFatPercentage: estimatedBF.toFixed(1)
                    },
                    metabolicProfile: {
                        flexibility: metabolicFactors,
                        type: this.determineMetabolicType(userData),
                        efficiency: this.calculateMetabolicEfficiency(userData)
                    }
                };
            }

            // Determine metabolic type based on responses
            determineMetabolicType(userData) {
                let carboScore = 0;
                let proteinScore = 0;
                let fatScore = 0;

                // Weight pattern influence
                if (userData.weightPattern === 'gain_very_easy') carboScore += 2;
                else if (userData.weightPattern === 'lose_very_hard') carboScore += 1;
                else if (userData.weightPattern === 'lose_easy') fatScore += 2;

                // Appetite pattern
                if (userData.appetitePattern === 'always_hungry') carboScore += 1;
                else if (userData.appetitePattern === 'very_low') fatScore += 2;

                // Food cravings
                if (userData.foodCravings) {
                    if (userData.foodCravings.includes('carbs')) carboScore += 2;
                    if (userData.foodCravings.includes('protein')) proteinScore += 2;
                    if (userData.foodCravings.includes('fats')) fatScore += 2;
                }

                // Energy after meals
                if (userData.postMealEnergy === 'sleepy') carboScore += 1;
                else if (userData.postMealEnergy === 'energetic') proteinScore += 1;

                const maxScore = Math.max(carboScore, proteinScore, fatScore);
                let metabolicType;
                
                if (carboScore === maxScore) {
                    metabolicType = {
                        type: 'کربوهیدرات‌محور',
                        description: 'بدن شما به کربوهیدرات پاسخ بهتری می‌دهد',
                        macroRatio: { carbs: 50, protein: 25, fat: 25 },
                        recommendations: [
                            'کربوهیدرات‌های پیچیده مصرف کنید',
                            'تایمینگ کربوهیدرات حول تمرین',
                            'جلوگیری از کربوهیدرات‌های ساده'
                        ]
                    };
                } else if (proteinScore === maxScore) {
                    metabolicType = {
                        type: 'پروتئین‌محور',
                        description: 'بدن شما به پروتئین و آمینواسیدها پاسخ بهتری می‌دهد',
                        macroRatio: { carbs: 30, protein: 40, fat: 30 },
                        recommendations: [
                            'پروتئین در هر وعده',
                            'انواع مختلف منابع پروتئین',
                            'آمینواسیدهای ضروری'
                        ]
                    };
                } else {
                    metabolicType = {
                        type: 'چربی‌محور',
                        description: 'بدن شما به چربی‌های سالم پاسخ بهتری می‌دهد',
                        macroRatio: { carbs: 20, protein: 25, fat: 55 },
                        recommendations: [
                            'چربی‌های سالم غیراشباع',
                            'کاهش کربوهیدرات‌ها',
                            'کتوژنیک یا کم‌کربوهیدرات'
                        ]
                    };
                }

                return metabolicType;
            }

            // Calculate metabolic efficiency
            calculateMetabolicEfficiency(userData) {
                let efficiency = 50; // base efficiency

                // Age factor
                const age = parseInt(userData.age);
                if (age < 25) efficiency += 10;
                else if (age < 35) efficiency += 5;
                else if (age > 45) efficiency -= 5;
                else if (age > 55) efficiency -= 10;

                // Activity factor
                const activityBonus = {
                    'sedentary': -10,
                    'light': -5,
                    'moderate': 0,
                    'active': 5,
                    'very_active': 10
                };
                efficiency += activityBonus[userData.dailyActivity] || 0;

                // Sleep factor
                const sleepBonus = {
                    'less_5': -15,
                    '5_6': -10,
                    '6_7': -5,
                    '7_8': 5,
                    '8_9': 10,
                    'more_9': 0
                };
                efficiency += sleepBonus[userData.sleepHours] || 0;

                // Stress factor
                const stressBonus = {
                    'very_low': 10,
                    'low': 5,
                    'moderate': 0,
                    'high': -5,
                    'very_high': -15
                };
                efficiency += stressBonus[userData.stressLevel] || 0;

                // Energy level factor
                const energyBonus = {
                    'very_low': -10,
                    'low': -5,
                    'moderate': 0,
                    'high': 5,
                    'very_high': 10
                };
                efficiency += energyBonus[userData.energyLevel] || 0;

                efficiency = Math.max(0, Math.min(100, efficiency));

                let category;
                if (efficiency >= 80) category = 'بسیار بالا';
                else if (efficiency >= 65) category = 'بالا';
                else if (efficiency >= 50) category = 'متوسط';
                else if (efficiency >= 35) category = 'پایین';
                else category = 'بسیار پایین';

                return {
                    score: efficiency,
                    category: category,
                    factors: {
                        age: age < 35 ? 'مثبت' : 'منفی',
                        activity: ['active', 'very_active'].includes(userData.dailyActivity) ? 'مثبت' : 'منفی',
                        sleep: ['7_8', '8_9'].includes(userData.sleepHours) ? 'مثبت' : 'منفی',
                        stress: ['very_low', 'low'].includes(userData.stressLevel) ? 'مثبت' : 'منفی'
                    }
                };
            }

            // Complete scientific analysis
            performCompleteAnalysis(userData) {
                this.userData = userData;
                
                // Core metrics
                const metabolicAnalysis = this.performMetabolicAnalysis(userData);
                const somatotype = this.calculateSomatotype(userData);
                const fitnessLevel = this.assessAdvancedFitness(userData);
                
                // Goal-specific calculations
                const goalAnalysis = this.analyzeGoalFeasibility(userData, metabolicAnalysis, somatotype, fitnessLevel);
                
                // Risk assessment
                const riskAssessment = this.performRiskAssessment(userData);
                
                // Generate personalized recommendations
                const recommendations = this.generateIntelligentRecommendations(
                    userData, metabolicAnalysis, somatotype, fitnessLevel, goalAnalysis
                );

                this.analysisResults = {
                    metabolic: metabolicAnalysis,
                    somatotype: somatotype,
                    fitness: fitnessLevel,
                    goals: goalAnalysis,
                    risks: riskAssessment,
                    recommendations: recommendations,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };

                return this.analysisResults;
            }

            // Analyze goal feasibility
            analyzeGoalFeasibility(userData, metabolic, somatotype, fitness) {
                const goal = userData.primaryGoal;
                const currentWeight = parseFloat(userData.weight);
                const targetWeight = parseFloat(userData.targetWeight);
                const weightDifference = currentWeight - targetWeight;
                
                let feasibility, timeline, challenges, advantages;

                switch(goal) {
                    case 'weight_loss':
                        const safeWeightLoss = currentWeight * 0.02; // 2% per week max
                        const weeksNeeded = Math.abs(weightDifference) / safeWeightLoss;
                        
                        feasibility = weightDifference > 0 ? 'عالی' : 'نامعقول';
                        timeline = `${Math.ceil(weeksNeeded)} هفته`;
                        
                        if (somatotype.name === 'اندومورف') {
                            challenges = ['متابولیسم کند', 'نیاز به کنترل دقیق کالری'];
                            advantages = ['پاسخ خوب به تمرینات قدرتی'];
                        } else if (somatotype.name === 'مزومورف') {
                            challenges = ['نیاز به تعادل در رژیم'];
                            advantages = ['پاسخ سریع به تمرین', 'متابولیسم مناسب'];
                        } else {
                            challenges = ['احتمال کاهش عضله'];
                            advantages = ['متابولیسم سریع', 'سوزاندن چربی آسان'];
                        }
                        break;

                    case 'muscle_gain':
                        const expectedGain = fitness.level === 'تازه‌کار' ? 1 : 
                                           fitness.level === 'مبتدی' ? 0.7 : 0.4; // kg per month
                        const muscleWeeksNeeded = Math.abs(weightDifference) / (expectedGain / 4);
                        
                        feasibility = somatotype.name === 'مزومورف' ? 'عالی' : 
                                     somatotype.name === 'اندومورف' ? 'خوب' : 'سخت';
                        timeline = `${Math.ceil(muscleWeeksNeeded)} هفته`;
                        
                        if (somatotype.name === 'اکتومورف') {
                            challenges = ['نیاز به کالری بسیار زیاد', 'عضله‌سازی کند'];
                            advantages = ['تعریف عضلانی عالی', 'کم‌چربی طبیعی'];
                        }
                        break;

                    case 'strength':
                        const strengthGain = fitness.level === 'تازه‌کار' ? '50-100%' : 
                                           fitness.level === 'مبتدی' ? '25-50%' : '10-25%';
                        
                        feasibility = 'عالی';
                        timeline = '8-12 هفته برای نتایج اولیه';
                        challenges = ['نیاز به تمرین منظم', 'افزایش تدریجی بار'];
                        advantages = [`امکان بهبود ${strengthGain}`, 'بهبود کیفیت زندگی'];
                        break;

                    default:
                        feasibility = 'قابل دستیابی';
                        timeline = '8-16 هفته';
                        challenges = ['نیاز به صبر و پشتکار'];
                        advantages = ['بهبود سلامت کلی'];
                }

                return {
                    goal: goal,
                    feasibility: feasibility,
                    timeline: timeline,
                    challenges: challenges,
                    advantages: advantages,
                    currentVsTarget: {
                        current: currentWeight,
                        target: targetWeight,
                        difference: weightDifference.toFixed(1)
                    },
                    recommendations: this.getGoalSpecificRecommendations(goal, somatotype, fitness)
                };
            }

            // Risk assessment based on health data
            performRiskAssessment(userData) {
                let riskFactors = [];
                let recommendations = [];
                let overallRisk = 'کم';

                // Age-related risks
                const age = parseInt(userData.age);
                if (age > 50) {
                    riskFactors.push('سن بالای 50 سال');
                    recommendations.push('مشورت با پزشک قبل شروع');
                }

                // BMI-related risks
                const weight = parseFloat(userData.weight);
                const height = parseFloat(userData.height);
                const bmi = weight / Math.pow(height / 100, 2);
                
                if (bmi > 30) {
                    riskFactors.push('چاقی (BMI > 30)');
                    recommendations.push('شروع تدریجی تمرینات');
                    overallRisk = 'متوسط';
                } else if (bmi < 18.5) {
                    riskFactors.push('کم‌وزنی (BMI < 18.5)');
                    recommendations.push('تمرکز بر تقویت تدریجی');
                }

                // Health conditions
                const healthConditions = userData.healthConditions || [];
                if (healthConditions.includes('heart_disease')) {
                    riskFactors.push('مشکل قلبی');
                    recommendations.push('مشورت حتمی با کاردیولوژیست');
                    overallRisk = 'بالا';
                }
                if (healthConditions.includes('hypertension')) {
                    riskFactors.push('فشار خون بالا');
                    recommendations.push('کنترل فشار خون قبل تمرین');
                    overallRisk = 'متوسط';
                }
                if (healthConditions.includes('diabetes')) {
                    riskFactors.push('دیابت');
                    recommendations.push('کنترل قند خون');
                    overallRisk = 'متوسط';
                }

                // Injury history
                const injuries = userData.injuries || [];
                if (injuries.includes('back_pain')) {
                    riskFactors.push('سابقه درد کمر');
                    recommendations.push('اجتناب از حرکات فشاری روی ستون فقرات');
                }
                if (injuries.includes('knee_pain')) {
                    riskFactors.push('مشکل زانو');
                    recommendations.push('محدودیت در تمرینات پای پایین');
                }

                // Lifestyle risks
                if (userData.sleepHours === 'less_5') {
                    riskFactors.push('کمبود خواب شدید');
                    recommendations.push('بهبود الگوی خواب اولویت اول');
                }
                if (userData.stressLevel === 'very_high') {
                    riskFactors.push('استرس بسیار بالا');
                    recommendations.push('تکنیک‌های کاهش استرس');
                }

                return {
                    overallRisk: overallRisk,
                    riskFactors: riskFactors,
                    recommendations: recommendations,
                    clearanceNeeded: overallRisk === 'بالا',
                    modifications: this.generateSafetyModifications(userData)
                };
            }

            // Generate safety modifications
            generateSafetyModifications(userData) {
                const modifications = [];
                const injuries = userData.injuries || [];
                const healthConditions = userData.healthConditions || [];

                if (injuries.includes('back_pain')) {
                    modifications.push({
                        area: 'کمر',
                        avoid: ['ددلیفت معمولی', 'اسکوات آزاد با وزن سنگین', 'بالا کشیدن از زمین'],
                        modify: ['ددلیفت رومانی', 'اسکوات گابلت', 'هایپراکستنشن'],
                        focus: ['تقویت عضلات مرکزی', 'کشش همسترینگ', 'موبیلیتی مهره‌ها']
                    });
                }

                if (injuries.includes('knee_pain')) {
                    modifications.push({
                        area: 'زانو',
                        avoid: ['اسکوات عمیق', 'لانج با قدم بلند', 'دویدن روی سطح سخت'],
                        modify: ['اسکوات تا 90 درجه', 'لانج استاتیک', 'دویدن روی تردمیل'],
                        focus: ['تقویت چهارسر', 'کشش IT Band', 'تعادل و تحرک']
                    });
                }

                if (healthConditions.includes('hypertension')) {
                    modifications.push({
                        area: 'فشار خون',
                        avoid: ['والسالوا شدید', 'حبس نفس طولانی', 'حرکات سر پایین'],
                        modify: ['تنفس مناسب', 'استراحت بین ست‌ها', 'کنترل شدت'],
                        focus: ['تمرینات هوازی ملایم', 'کاهش استرس', 'کنترل مداوم']
                    });
                }

                return modifications;
            }

            // Get goal-specific recommendations
            getGoalSpecificRecommendations(goal, somatotype, fitness) {
                const recommendations = {
                    training: [],
                    nutrition: [],
                    timeline: '',
                    expectations: []
                };

                switch(goal) {
                    case 'weight_loss':
                        recommendations.training = [
                            'ترکیب 60% تمرینات قدرتی + 40% هوازی',
                            'تمرینات HIIT 2-3 بار در هفته',
                            'تمرینات کل بدن برای حداکثر سوزاندن کالری'
                        ];
                        recommendations.nutrition = [
                            `کسری کالری ${somatotype.name === 'اندومورف' ? '500-750' : '300-500'} کالری`,
                            'پروتئین بالا: 2.2-2.5 گرم بر کیلو وزن',
                            'تایمینگ کربوهیدرات حول تمرین'
                        ];
                        recommendations.timeline = 'نتایج محسوس: 4-6 هفته، هدف نهایی: 12-24 هفته';
                        break;

                    case 'muscle_gain':
                        recommendations.training = [
                            'تمرینات قدرتی 4-5 بار در هفته',
                            '6-12 تکرار برای هایپرتروفی',
                            'تمرکز بر حرکات کامپوند'
                        ];
                        recommendations.nutrition = [
                            `مازاد کالری ${somatotype.name === 'اکتومورف' ? '500-800' : '300-500'} کالری`,
                            'پروتئین: 2-2.5 گرم بر کیلو وزن',
                            'کربوهیدرات کافی برای انرژی'
                        ];
                        recommendations.timeline = 'تغییرات اولیه: 6-8 هفته، نتایج چشمگیر: 12-16 هفته';
                        break;

                    case 'strength':
                        recommendations.training = [
                            'تمرینات قدرتی 3-4 بار در هفته',
                            '1-6 تکرار با وزن سنگین',
                            'تمرکز بر big 3: اسکوات، ددلیفت، پرس'
                        ];
                        recommendations.nutrition = [
                            'کالری تعادل یا مازاد جزئی',
                            'پروتئین: 1.8-2.2 گرم بر کیلو',
                            'کربوهیدرات برای انرژی تمرین'
                        ];
                        recommendations.timeline = 'افزایش قدرت: 2-4 هفته، نتایج قابل توجه: 8-12 هفته';
                        break;
                }

                // Adjust based on fitness level
                if (fitness.level === 'تازه‌کار') {
                    recommendations.expectations = [
                        'شروع بسیار تدریجی',
                        'تمرکز بر یادگیری تکنیک',
                        'افزایش 10-15% هر هفته'
                    ];
                } else if (fitness.level === 'پیشرفته') {
                    recommendations.expectations = [
                        'نتایج سریع‌تر',
                        'امکان شدت بالاتر',
                        'تنوع بیشتر در برنامه'
                    ];
                }

                return recommendations;
            }

            // Generate intelligent recommendations
            generateIntelligentRecommendations(userData, metabolic, somatotype, fitness, goals) {
                return {
                    immediate: this.getImmediateActions(userData, metabolic, fitness),
                    shortTerm: this.getShortTermPlan(userData, somatotype, goals),
                    longTerm: this.getLongTermStrategy(userData, metabolic, goals),
                    lifestyle: this.getLifestyleOptimizations(userData),
                    supplements: this.getSupplementRecommendations(userData, goals),
                    monitoring: this.getMonitoringPlan(userData, goals)
                };
            }

            // Immediate actions (first week)
            getImmediateActions(userData, metabolic, fitness) {
                const actions = [];

                if (fitness.level === 'تازه‌کار') {
                    actions.push('شروع با 10-15 دقیقه پیاده‌روی روزانه');
                    actions.push('یادگیری حرکات پایه بدون وزن');
                }

                if (metabolic.bmr.accuracy < 90) {
                    actions.push('اندازه‌گیری دقیق‌تر ترکیب بدن');
                }

                if (userData.sleepHours === 'less_5') {
                    actions.push('اولویت اول: بهبود خواب به 7-8 ساعت');
                }

                if (userData.waterIntake < 2) {
                    actions.push('افزایش مصرف آب به 2.5-3 لیتر روزانه');
                }

                return actions;
            }

            // Short-term plan (4-8 weeks)
            getShortTermPlan(userData, somatotype, goals) {
                const plan = {
                    weeks1_2: [],
                    weeks3_4: [],
                    weeks5_8: []
                };

                // First 2 weeks: Adaptation
                plan.weeks1_2 = [
                    'ایجاد عادت تمرین منظم',
                    'یادگیری فرم صحیح حرکات',
                    'تنظیم الگوی غذایی'
                ];

                // Weeks 3-4: Progression
                plan.weeks3_4 = [
                    'افزایش حجم تمرین',
                    'اضافه کردن حرکات جدید',
                    'بهینه‌سازی تغذیه'
                ];

                // Weeks 5-8: Development
                plan.weeks5_8 = [
                    'افزایش شدت تمرینات',
                    'تخصصی شدن برنامه',
                    'ارزیابی پیشرفت و تنظیم'
                ];

                return plan;
            }

            // Long-term strategy (3-6 months)
            getLongTermStrategy(userData, metabolic, goals) {
                const strategy = [];

                if (goals.goal === 'weight_loss') {
                    strategy.push('کاهش تدریجی 0.5-1 کیلو در هفته');
                    strategy.push('حفظ عضله با تمرینات قدرتی');
                    strategy.push('ایجاد عادات غذایی پایدار');
                } else if (goals.goal === 'muscle_gain') {
                    strategy.push('افزایش 2-4 کیلو عضله در 6 ماه');
                    strategy.push('پیشرفت تدریجی در وزنه‌ها');
                    strategy.push('بهینه‌سازی ریکاوری');
                }

                strategy.push('ارزیابی ماهانه و تنظیم برنامه');
                strategy.push('یادگیری مهارت‌های جدید');
                strategy.push('ایجاد سبک زندگی فعال');

                return strategy;
            }

            // Lifestyle optimizations
            getLifestyleOptimizations(userData) {
                const optimizations = {};

                // Sleep optimization
                if (userData.sleepQuality !== 'excellent') {
                    optimizations.sleep = [
                        'ایجاد روتین خواب ثابت',
                        'اتاق خواب تاریک و خنک',
                        'اجتناب از صفحه نمایش 1 ساعت قبل خواب'
                    ];
                }

                // Stress management
                if (['high', 'very_high'].includes(userData.stressLevel)) {
                    optimizations.stress = [
                        'تکنیک‌های تنفس عمیق',
                        'مدیتیشن 10 دقیقه روزانه',
                        'تمرینات یوگا یا کششی'
                    ];
                }

                // Energy optimization
                if (['low', 'very_low'].includes(userData.energyLevel)) {
                    optimizations.energy = [
                        'صبحانه پرپروتئین',
                        'وعده‌های کوچک و مکرر',
                        'تمرین صبحگاهی سبک'
                    ];
                }

                return optimizations;
            }

            // Supplement recommendations
            getSupplementRecommendations(userData, goals) {
                const supplements = {
                    essential: [
                        { name: 'مولتی ویتامین', dosage: '1 عدد روزانه', timing: 'با صبحانه' },
                        { name: 'ویتامین D3', dosage: '2000 IU', timing: 'روزانه' }
                    ],
                    conditional: [],
                    goalSpecific: []
                };

                // Conditional based on diet
                if (userData.dietType === 'vegetarian' || userData.dietType === 'vegan') {
                    supplements.conditional.push(
                        { name: 'B12', dosage: '250 mcg', timing: 'روزانه' }
                    );
                }

                // Goal-specific
                if (goals.goal === 'muscle_gain') {
                    supplements.goalSpecific.push(
                        { name: 'پروتئین وی', dosage: '25-30g', timing: 'بعد از تمرین' },
                        { name: 'کراتین', dosage: '5g', timing: 'روزانه' }
                    );
                } else if (goals.goal === 'weight_loss') {
                    supplements.goalSpecific.push(
                        { name: 'L-کارنیتین', dosage: '2g', timing: 'قبل از تمرین' },
                        { name: 'چای سبز', dosage: '2 فنجان', timing: 'بین وعده‌ها' }
                    );
                }

                return supplements;
            }

            // Monitoring plan
            getMonitoringPlan(userData, goals) {
                return {
                    daily: [
                        'وزن بدن (صبح ناشتا)',
                        'ساعات خواب',
                        'سطح انرژی (1-10)',
                        'مصرف آب'
                    ],
                    weekly: [
                        'عکس پیشرفت',
                        'اندازه‌گیری دور کمر',
                        'تست عملکردی (شنا، پلانک)',
                        'ارزیابی خلق و خو'
                    ],
                    monthly: [
                        'درصد چربی بدن',
                        'تست‌های آمادگی کامل',
                        'بررسی اهداف و تنظیم',
                        'مشورت با متخصص'
                    ]
                };
            }
        }

        // Advanced Program Generator with Real Intelligence
        class IntelligentProgramGenerator {
            constructor(userData, analysisResults) {
                this.userData = userData;
                this.analysis = analysisResults;
                this.exerciseDatabase = this.initializeAdvancedExerciseDatabase();
                this.nutritionDatabase = this.initializeNutritionDatabase();
            }

            // Initialize comprehensive exercise database
            initializeAdvancedExerciseDatabase() {
                return {
                    strength: {
                        compound: {
                            beginner: [
                                { 
                                    name: 'اسکوات وزن بدن', 
                                    muscle: ['چهارسر', 'گلوت', 'همسترینگ'], 
                                    difficulty: 'آسان', 
                                    equipment: 'bodyweight',
                                    form: 'پاها شانه‌عرض، زانوها خط انگشتان پا، سینه بالا',
                                    progression: 'افزایش تعداد → یک پا → اسکوات جامپ',
                                    contraindications: ['knee_pain'],
                                    modifications: {
                                        'knee_pain': 'اسکوات تا 90 درجه',
                                        'back_pain': 'تکیه به دیوار'
                                    }
                                },
                                { 
                                    name: 'شنای سینه', 
                                    muscle: ['سینه', 'سه‌سر', 'شانه جلو'], 
                                    difficulty: 'آسان', 
                                    equipment: 'bodyweight',
                                    form: 'بدن صاف، دست‌ها شانه‌عرض، نگاه رو به جلو',
                                    progression: 'زانو → کامل → diamond → یک دست',
                                    contraindications: ['shoulder_pain', 'wrist_pain'],
                                    modifications: {
                                        'shoulder_pain': 'شنای سینه مایل',
                                        'wrist_pain': 'مشت‌ها روی زمین'
                                    }
                                }
                            ],
                            intermediate: [
                                { 
                                    name: 'اسکوات گابلت', 
                                    muscle: ['چهارسر', 'گلوت', 'مرکزی'], 
                                    difficulty: 'متوسط', 
                                    equipment: 'dumbbells',
                                    form: 'دمبل نزدیک سینه، آرنج‌ها پایین',
                                    progression: 'افزایش وزن → اسکوات فرانت',
                                    contraindications: ['back_pain'],
                                    modifications: {
                                        'knee_pain': 'محدودیت عمق'
                                    }
                                }
                            ],
                            advanced: [
                                { 
                                    name: 'اسکوات هالتر', 
                                    muscle: ['چهارسر', 'گلوت', 'مرکزی'], 
                                    difficulty: 'سخت', 
                                    equipment: 'barbell',
                                    form: 'هالتر روی ذوزنقه، پاها ثابت',
                                    progression: 'افزایش وزن → اسکوات فرانت → اسکوات overhead',
                                    contraindications: ['back_pain', 'shoulder_pain'],
                                    modifications: {
                                        'back_pain': 'حذف از برنامه'
                                    }
                                }
                            ]
                        },
                        isolation: {
                            beginner: [
                                { 
                                    name: 'دراز کش دوسر', 
                                    muscle: ['دوسر'], 
                                    difficulty: 'آسان', 
                                    equipment: 'dumbbells'
                                }
                            ],
                            intermediate: [
                                { 
                                    name: 'کرل هالتر', 
                                    muscle: ['دوسر'], 
                                    difficulty: 'متوسط', 
                                    equipment: 'barbell'
                                }
                            ]
                        }
                    },
                    cardio: {
                        low_intensity: [
                            { 
                                name: 'پیاده‌روی سریع', 
                                duration: '20-45', 
                                intensity: 'کم',
                                heartRate: '60-70% HRmax',
                                fatBurn: 'بالا',
                                equipment: 'none'
                            },
                            { 
                                name: 'دوچرخه آرام', 
                                duration: '20-60', 
                                intensity: 'کم',
                                heartRate: '60-70% HRmax',
                                equipment: 'bike'
                            }
                        ],
                        moderate_intensity: [
                            { 
                                name: 'دویدن متوسط', 
                                duration: '15-30', 
                                intensity: 'متوسط',
                                heartRate: '70-80% HRmax',
                                equipment: 'none'
                            }
                        ],
                        high_intensity: [
                            { 
                                name: 'HIIT', 
                                duration: '15-25', 
                                intensity: 'بالا',
                                heartRate: '80-90% HRmax',
                                structure: '30s کار / 30s استراحت',
                                equipment: 'none'
                            }
                        ]
                    },
                    flexibility: [
                        { 
                            name: 'کشش همسترینگ', 
                            duration: '30-60s', 
                            type: 'static',
                            target: ['همسترینگ', 'کمر پایین']
                        },
                        { 
                            name: 'کشش چهارسر', 
                            duration: '30-60s', 
                            type: 'static',
                            target: ['چهارسر']
                        }
                    ],
                    martial_arts: [
                        { 
                            name: 'شادو باکسینگ', 
                            duration: '3-5 دقیقه', 
                            skill: 'basic',
                            focus: ['تکنیک', 'کاردیو']
                        },
                        { 
                            name: 'کیک پد', 
                            duration: '2-3 دقیقه', 
                            skill: 'intermediate',
                            focus: ['قدرت', 'دقت']
                        }
                    ],
                    rehabilitation: [
                        {
                            name: 'تحرک ستون فقرات',
                            target: 'back_pain',
                            duration: '5-10 دقیقه',
                            frequency: 'روزانه'
                        },
                        {
                            name: 'تقویت چهارسر',
                            target: 'knee_pain',
                            duration: '10-15 دقیقه',
                            frequency: '3 بار در هفته'
                        }
                    ]
                };
            }

            // Initialize nutrition database
            initializeNutritionDatabase() {
                return {
                    foods: {
                        protein: [
                            { name: 'سینه مرغ', protein: 25, carbs: 0, fat: 3, calories: 124 },
                            { name: 'تخم مرغ', protein: 13, carbs: 1, fat: 11, calories: 155 },
                            { name: 'ماهی سالمون', protein: 25, carbs: 0, fat: 13, calories: 208 },
                            { name: 'لوبیا قرمز', protein: 9, carbs: 23, fat: 0.5, calories: 127 }
                        ],
                        carbs: [
                            { name: 'برنج قهوه‌ای', protein: 3, carbs: 23, fat: 0.9, calories: 111 },
                            { name: 'سیب‌زمینی', protein: 2, carbs: 17, fat: 0.1, calories: 77 },
                            { name: 'جو دوسر', protein: 4, carbs: 28, fat: 1, calories: 135 }
                        ],
                        fats: [
                            { name: 'آووکادو', protein: 2, carbs: 9, fat: 15, calories: 160 },
                            { name: 'آجیل مخلوط', protein: 6, carbs: 6, fat: 16, calories: 185 },
                            { name: 'روغن زیتون', protein: 0, carbs: 0, fat: 14, calories: 119 }
                        ],
                        vegetables: [
                            { name: 'بروکلی', protein: 3, carbs: 6, fat: 0.4, calories: 25 },
                            { name: 'اسفناج', protein: 3, carbs: 4, fat: 0.4, calories: 23 }
                        ]
                    },
                    meals: {
                        breakfast: [
                            { 
                                name: 'اوملت سبزیجات', 
                                ingredients: ['تخم مرغ', 'اسفناج', 'گوجه', 'پنیر'],
                                calories: 320,
                                protein: 24,
                                suitableFor: ['weight_loss', 'muscle_gain']
                            }
                        ],
                        lunch: [
                            { 
                                name: 'سینه مرغ با برنج', 
                                ingredients: ['سینه مرغ', 'برنج قهوه‌ای', 'سبزیجات'],
                                calories: 450,
                                protein: 35,
                                suitableFor: ['muscle_gain', 'strength']
                            }
                        ],
                        dinner: [
                            { 
                                name: 'ماهی با سالاد', 
                                ingredients: ['ماهی سالمون', 'سالاد سبز', 'آووکادو'],
                                calories: 380,
                                protein: 30,
                                suitableFor: ['weight_loss', 'general_health']
                            }
                        ]
                    }
                };
            }

            // Generate complete personalized program
            generateCompleteProgram() {
                const weeklyProgram = this.generateIntelligentWeeklyProgram();
                const nutritionPlan = this.generatePreciseNutritionPlan();
                const supplementPlan = this.generateSupplementProtocol();
                const recoveryPlan = this.generateRecoveryProtocol();
                const progressionPlan = this.generateProgressionStrategy();

                return {
                    overview: this.generateProgramOverview(),
                    weekly: weeklyProgram,
                    nutrition: nutritionPlan,
                    supplements: supplementPlan,
                    recovery: recoveryPlan,
                    progression: progressionPlan,
                    monitoring: this.generateMonitoringPlan(),
                    contingencies: this.generateContingencyPlans()
                };
            }

            // Generate intelligent weekly program
            generateIntelligentWeeklyProgram() {
                const trainingDays = parseInt(this.userData.trainingDays);
                const sessionLength = parseInt(this.userData.sessionLength);
                const goal = this.userData.primaryGoal;
                const fitnessLevel = this.analysis.fitness.level;
                const equipment = this.userData.equipment || [];
                const exerciseTypes = this.userData.exerciseTypes || [];
                const injuries = this.userData.injuries || [];
                const somatotype = this.analysis.somatotype.name;

                const program = {
                    totalDays: trainingDays,
                    daysPerWeek: trainingDays,
                    sessionLength: sessionLength,
                    days: [],
                    restDays: 7 - trainingDays,
                    weeklyVolume: this.calculateOptimalVolume(goal, fitnessLevel, somatotype)
                };

                // Generate each training day with scientific precision
                for (let day = 1; day <= trainingDays; day++) {
                    const dayProgram = this.generateIntelligentDayProgram(
                        day, sessionLength, goal, fitnessLevel, equipment, 
                        exerciseTypes, injuries, somatotype
                    );
                    program.days.push(dayProgram);
                }

                return program;
            }

            // Calculate optimal training volume
            calculateOptimalVolume(goal, fitnessLevel, somatotype) {
                let baseVolume = 100; // base weekly volume (arbitrary units)

                // Adjust for fitness level
                const fitnessMultiplier = {
                    'تازه‌کار': 0.5,
                    'مبتدی': 0.7,
                    'متوسط': 1.0,
                    'متوسط بالا': 1.2,
                    'پیشرفته': 1.5,
                    'ورزشکار': 2.0
                };
                baseVolume *= fitnessMultiplier[fitnessLevel] || 1.0;

                // Adjust for somatotype
                const somatotypeMultiplier = {
                    'اندومورف': 1.2, // Can handle more volume
                    'مزومورف': 1.0,  // Optimal responder
                    'اکتومورف': 0.8  // Needs more recovery
                };
                baseVolume *= somatotypeMultiplier[somatotype] || 1.0;

                // Adjust for goal
                const goalMultiplier = {
                    'weight_loss': 1.3,    // Higher volume for calorie burn
                    'muscle_gain': 1.0,    // Moderate volume for growth
                    'strength': 0.8,       // Lower volume, higher intensity
                    'endurance': 1.5,      // High volume
                    'martial_arts': 1.1,   // Moderate-high volume
                    'flexibility': 0.6,    // Lower volume
                    'rehabilitation': 0.4   // Very low volume
                };
                baseVolume *= goalMultiplier[goal] || 1.0;

                return Math.round(baseVolume);
            }

            // Generate intelligent day program
            generateIntelligentDayProgram(dayNumber, sessionLength, goal, fitnessLevel, equipment, exerciseTypes, injuries, somatotype) {
                const dayProgram = {
                    day: dayNumber,
                    name: this.generateIntelligentDayName(dayNumber, goal, equipment),
                    duration: sessionLength,
                    focus: this.determineDayFocus(dayNumber, goal),
                    warmup: this.generateIntelligentWarmup(dayNumber, goal, injuries),
                    mainExercises: [],
                    cooldown: this.generateIntelligentCooldown(dayNumber, goal, injuries),
                    notes: [],
                    intensity: this.calculateDayIntensity(dayNumber, goal, fitnessLevel),
                    volume: this.calculateDayVolume(dayNumber, goal, sessionLength)
                };

                // Allocate time intelligently
                const warmupTime = Math.min(15, sessionLength * 0.2);
                const cooldownTime = Math.min(15, sessionLength * 0.15);
                const mainWorkoutTime = sessionLength - warmupTime - cooldownTime;

                // Generate main workout with scientific approach
                dayProgram.mainExercises = this.generateMainWorkoutIntelligent(
                    dayNumber, mainWorkoutTime, goal, fitnessLevel, equipment, 
                    exerciseTypes, injuries, somatotype
                );

                // Add intelligent notes
                dayProgram.notes = this.generateIntelligentNotes(
                    dayNumber, goal, injuries, somatotype, fitnessLevel
                );

                return dayProgram;
            }

            // Generate intelligent main workout
            generateMainWorkoutIntelligent(dayNumber, availableTime, goal, fitnessLevel, equipment, exerciseTypes, injuries, somatotype) {
                const exercises = [];
                const dayFocus = this.determineDayFocus(dayNumber, goal);
                
                // Determine exercise selection strategy
                const strategy = this.determineExerciseStrategy(goal, fitnessLevel, somatotype);
                
                // Calculate sets, reps, and rest based on goal and science
                const workoutParameters = this.calculateWorkoutParameters(goal, fitnessLevel, somatotype);

                if (goal === 'weight_loss') {
                    exercises.push(...this.generateWeightLossWorkout(availableTime, equipment, injuries, workoutParameters));
                } else if (goal === 'muscle_gain') {
                    exercises.push(...this.generateMuscleGainWorkout(dayNumber, availableTime, equipment, injuries, workoutParameters));
                } else if (goal === 'strength') {
                    exercises.push(...this.generateStrengthWorkout(dayNumber, availableTime, equipment, injuries, workoutParameters));
                } else if (goal === 'endurance') {
                    exercises.push(...this.generateEnduranceWorkout(availableTime, equipment, injuries, workoutParameters));
                } else if (goal === 'martial_arts') {
                    exercises.push(...this.generateMartialArtsWorkout(dayNumber, availableTime, equipment, workoutParameters));
                } else if (goal === 'flexibility') {
                    exercises.push(...this.generateFlexibilityWorkout(availableTime, injuries, workoutParameters));
                } else if (goal === 'rehabilitation') {
                    exercises.push(...this.generateRehabilitationWorkout(availableTime, injuries, workoutParameters));
                } else {
                    exercises.push(...this.generateGeneralHealthWorkout(availableTime, equipment, injuries, workoutParameters));
                }

                return exercises;
            }

            // Calculate workout parameters based on science
            calculateWorkoutParameters(goal, fitnessLevel, somatotype) {
                const baseParameters = {
                    sets: 3,
                    reps: 12,
                    rest: 60,
                    intensity: 70, // % of 1RM
                    density: 1.0   // exercises per minute
                };

                // Adjust for goal (based on NASM guidelines)
                const goalAdjustments = {
                    'weight_loss': { sets: 3, reps: 15, rest: 45, intensity: 65, density: 1.2 },
                    'muscle_gain': { sets: 4, reps: 10, rest: 90, intensity: 75, density: 0.8 },
                    'strength': { sets: 5, reps: 5, rest: 180, intensity: 85, density: 0.6 },
                    'endurance': { sets: 2, reps: 20, rest: 30, intensity: 60, density: 1.5 },
                    'martial_arts': { sets: 3, reps: 12, rest: 60, intensity: 70, density: 1.1 },
                    'flexibility': { sets: 1, reps: 1, rest: 15, intensity: 30, density: 2.0 }
                };

                const adjustments = goalAdjustments[goal] || baseParameters;
                
                // Adjust for fitness level
                const fitnessAdjustments = {
                    'تازه‌کار': { sets: 0.7, intensity: 0.8, rest: 1.5 },
                    'مبتدی': { sets: 0.8, intensity: 0.9, rest: 1.2 },
                    'متوسط': { sets: 1.0, intensity: 1.0, rest: 1.0 },
                    'پیشرفته': { sets: 1.2, intensity: 1.1, rest: 0.8 }
                };

                const fitnessAdj = fitnessAdjustments[fitnessLevel] || { sets: 1, intensity: 1, rest: 1 };

                // Adjust for somatotype
                const somatotypeAdjustments = {
                    'اندومورف': { rest: 0.8, density: 1.2 }, // Less rest, more density
                    'مزومورف': { rest: 1.0, density: 1.0 },  // Standard
                    'اکتومورف': { rest: 1.3, density: 0.8 }  // More rest, less density
                };

                const somAdj = somatotypeAdjustments[somatotype] || { rest: 1, density: 1 };

                return {
                    sets: Math.round(adjustments.sets * fitnessAdj.sets),
                    reps: adjustments.reps,
                    rest: Math.round(adjustments.rest * fitnessAdj.rest * somAdj.rest),
                    intensity: Math.round(adjustments.intensity * fitnessAdj.intensity),
                    density: adjustments.density * somAdj.density
                };
            }

            // Generate weight loss workout
            generateWeightLossWorkout(availableTime, equipment, injuries, params) {
                const exercises = [];
                const timePerExercise = 6; // minutes including rest
                const maxExercises = Math.floor(availableTime / timePerExercise);

                // Circuit training approach for maximum calorie burn
                const circuitExercises = this.selectExercisesForGoal(
                    'weight_loss', equipment, injuries, maxExercises
                );

                circuitExercises.forEach((exercise, index) => {
                    exercises.push({
                        name: exercise.name,
                        type: 'سوزاندن چربی',
                        muscle: Array.isArray(exercise.muscle) ? exercise.muscle.join(', ') : exercise.muscle,
                        sets: `${params.sets} دور`,
                        reps: `${params.reps} تکرار`,
                        rest: `${params.rest} ثانیه`,
                        intensity: `${params.intensity}% حداکثر`,
                        notes: exercise.modifications && injuries.some(injury => exercise.contraindications?.includes(injury))
                            ? `⚠️ ${exercise.modifications[injuries.find(injury => exercise.contraindications?.includes(injury))]}`
                            : '🔥 تمرکز بر سوزاندن کالری',
                        caloriesBurn: this.estimateCaloriesBurn(exercise, params),
                        form: exercise.form || 'فرم صحیح را رعایت کنید'
                    });
                });

                // Add cardio finisher if time allows
                if (availableTime > maxExercises * timePerExercise) {
                    exercises.push({
                        name: 'فینیشر کاردیو',
                        type: 'هوازی شدید',
                        sets: '1 دور',
                        reps: '5-10 دقیقه',
                        rest: '0 ثانیه',
                        intensity: '80-90% ضربان قلب حداکثر',
                        notes: '💨 آخرین فشار برای حداکثر سوزاندن',
                        caloriesBurn: this.estimateCardioCalories(8, 85) // 8 minutes at 85% intensity
                    });
                }

                return exercises;
            }

            // Generate muscle gain workout  
            generateMuscleGainWorkout(dayNumber, availableTime, equipment, injuries, params) {
                const exercises = [];
                const muscleGroups = this.getMuscleGroupSplit(dayNumber);
                const timePerExercise = 8; // More time for muscle building
                const maxExercises = Math.floor(availableTime / timePerExercise);

                // Progressive overload focused approach
                const selectedExercises = this.selectMuscleGainExercises(
                    muscleGroups, equipment, injuries, maxExercises
                );

                selectedExercises.forEach(exercise => {
                    exercises.push({
                        name: exercise.name,
                        type: 'عضله‌سازی',
                        muscle: Array.isArray(exercise.muscle) ? exercise.muscle.join(', ') : exercise.muscle,
                        sets: `${params.sets} ست`,
                        reps: `${params.reps} تکرار`,
                        rest: `${params.rest} ثانیه`,
                        intensity: `${params.intensity}% 1RM`,
                        notes: this.getMuscleGainNotes(exercise, params),
                        progression: exercise.progression || 'افزایش وزن هر هفته',
                        form: exercise.form || 'کنترل کامل در هر تکرار',
                        tempo: '3-1-2-1 (پایین-توقف-بالا-توقف)'
                    });
                });

                return exercises;
            }

            // Generate strength workout
            generateStrengthWorkout(dayNumber, availableTime, equipment, injuries, params) {
                const exercises = [];
                const strengthPattern = this.getStrengthPattern(dayNumber);
                const timePerExercise = 10; // Maximum time for strength
                const maxExercises = Math.floor(availableTime / timePerExercise);

                // Focus on compound movements
                const strengthExercises = this.selectStrengthExercises(
                    strengthPattern, equipment, injuries, maxExercises
                );

                strengthExercises.forEach(exercise => {
                    exercises.push({
                        name: exercise.name,
                        type: 'قدرت',
                        muscle: Array.isArray(exercise.muscle) ? exercise.muscle.join(', ') : exercise.muscle,
                        sets: `${params.sets} ست`,
                        reps: `${params.reps} تکرار`,
                        rest: `${params.rest} ثانیه`,
                        intensity: `${params.intensity}% 1RM`,
                        notes: '💪 تمرکز بر قدرت حداکثر',
                        warmupSets: this.calculateWarmupSets(params.intensity),
                        form: exercise.form || 'فرم عالی بر سرعت اولویت دارد',
                        rpe: this.calculateRPE(params.intensity)
                    });
                });

                return exercises;
            }

            // Estimate calories burned for exercise
            estimateCaloriesBurn(exercise, params) {
                // Simple METs calculation
                const bodyWeight = parseFloat(this.userData.weight);
                const exerciseMETs = {
                    'strength': 6,
                    'cardio': 8,
                    'compound': 7,
                    'isolation': 4
                };

                const mets = exerciseMETs[exercise.type] || 6;
                const timeInHours = (params.sets * params.reps * 3 + params.rest * params.sets) / 3600; // rough estimate
                
                return Math.round(mets * bodyWeight * timeInHours);
            }

            // Select exercises for specific goal
            selectExercisesForGoal(goal, equipment, injuries, maxExercises) {
                const availableExercises = [];
                
                // Filter exercises based on equipment
                Object.values(this.exerciseDatabase.strength.compound).forEach(level => {
                    level.forEach(exercise => {
                        if (equipment.includes(exercise.equipment) || exercise.equipment === 'bodyweight') {
                            // Check contraindications
                            if (!injuries.some(injury => exercise.contraindications?.includes(injury))) {
                                availableExercises.push(exercise);
                            }
                        }
                    });
                });

                // Prioritize compound movements for weight loss
                if (goal === 'weight_loss') {
                    availableExercises.sort((a, b) => {
                        const aIsCompound = Array.isArray(a.muscle) && a.muscle.length > 2;
                        const bIsCompound = Array.isArray(b.muscle) && b.muscle.length > 2;
                        if (aIsCompound && !bIsCompound) return -1;
                        if (!aIsCompound && bIsCompound) return 1;
                        return 0;
                    });
                }

                return availableExercises.slice(0, maxExercises);
            }

            // Get muscle group split for muscle gain
            getMuscleGroupSplit(dayNumber) {
                // Intelligent split based on day number
                const splits = {
                    2: { // 2-day split
                        1: ['سینه', 'شانه', 'سه‌سر'],
                        2: ['پشت', 'دوسر', 'پا']
                    },
                    3: { // 3-day split
                        1: ['سینه', 'سه‌سر'],
                        2: ['پشت', 'دوسر'],
                        3: ['پا', 'شانه']
                    },
                    4: { // 4-day split
                        1: ['سینه', 'سه‌سر'],
                        2: ['پشت', 'دوسر'],
                        3: ['پا'],
                        4: ['شانه', 'مرکزی']
                    },
                    5: { // 5-day split
                        1: ['سینه'],
                        2: ['پشت'],
                        3: ['پا'],
                        4: ['شانه'],
                        5: ['بازو']
                    }
                };

                const totalDays = parseInt(this.userData.trainingDays);
                const split = splits[totalDays] || splits[3];
                return split[((dayNumber - 1) % totalDays) + 1] || ['کل بدن'];
            }

            // Generate precise nutrition plan
            generatePreciseNutritionPlan() {
                const metabolic = this.analysis.metabolic;
                const goal = this.userData.primaryGoal;
                const somatotype = this.analysis.somatotype.name;
                const activityLevel = this.userData.dailyActivity;
                const trainingDays = parseInt(this.userData.trainingDays);

                // Calculate precise calorie needs
                const targetCalories = this.calculatePreciseCalories(metabolic, goal, activityLevel, trainingDays);
                
                // Calculate optimal macros
                const macros = this.calculateOptimalMacros(goal, somatotype, targetCalories);
                
                // Generate meal plan
                const mealPlan = this.generateIntelligentMealPlan(targetCalories, macros);
                
                // Calculate timing
                const nutrientTiming = this.generateNutrientTiming(trainingDays, goal);
                
                // Hydration plan
                const hydrationPlan = this.generateAdvancedHydrationPlan();

                return {
                    summary: {
                        dailyCalories: targetCalories,
                        macros: macros,
                        metabolicType: metabolic.metabolicProfile.type.type,
                        approach: this.getNutritionalApproach(goal, somatotype)
                    },
                    detailed: {
                        meals: mealPlan,
                        timing: nutrientTiming,
                        hydration: hydrationPlan,
                        supplements: this.analysis.recommendations.supplements
                    },
                    guidelines: this.generateNutritionalGuidelines(goal, somatotype),
                    tracking: this.generateNutritionTracking()
                };
            }

            // Calculate precise calories
            calculatePreciseCalories(metabolic, goal, activityLevel, trainingDays) {
                let baseCalories = metabolic.tdee.correctedTDEE;
                
                // Adjust for training frequency
                const trainingBonus = trainingDays * 50; // 50 calories per training day
                baseCalories += trainingBonus;
                
                // Goal-specific adjustments
                const goalAdjustments = {
                    'weight_loss': -500,     // 0.5kg per week loss
                    'muscle_gain': 300,      // Moderate surplus
                    'strength': 200,         // Small surplus
                    'endurance': 400,        // Higher needs
                    'martial_arts': 250,     // Moderate surplus
                    'flexibility': 0,        // Maintenance
                    'rehabilitation': -100,  // Slight deficit
                    'general_health': 0      // Maintenance
                };
                
                const adjustment = goalAdjustments[goal] || 0;
                return Math.round(baseCalories + adjustment);
            }

            // Calculate optimal macros
            calculateOptimalMacros(goal, somatotype, calories) {
                // Base ratios by goal
                const goalRatios = {
                    'weight_loss': { protein: 0.35, carbs: 0.30, fat: 0.35 },
                    'muscle_gain': { protein: 0.30, carbs: 0.45, fat: 0.25 },
                    'strength': { protein: 0.25, carbs: 0.50, fat: 0.25 },
                    'endurance': { protein: 0.20, carbs: 0.60, fat: 0.20 },
                    'martial_arts': { protein: 0.28, carbs: 0.42, fat: 0.30 },
                    'flexibility': { protein: 0.25, carbs: 0.45, fat: 0.30 },
                    'general_health': { protein: 0.25, carbs: 0.45, fat: 0.30 }
                };

                let ratios = goalRatios[goal] || goalRatios['general_health'];

                // Adjust for somatotype
                if (somatotype === 'اندومورف') {
                    ratios.carbs *= 0.85;  // Reduce carbs
                    ratios.protein *= 1.1; // Increase protein
                    ratios.fat *= 1.05;    // Slight increase in fat
                } else if (somatotype === 'اکتومورف') {
                    ratios.carbs *= 1.15;  // Increase carbs
                    ratios.fat *= 1.1;     // Increase fat
                    ratios.protein *= 0.95; // Slight decrease protein
                }

                // Normalize ratios
                const total = ratios.protein + ratios.carbs + ratios.fat;
                ratios.protein /= total;
                ratios.carbs /= total;
                ratios.fat /= total;

                // Convert to grams
                return {
                    protein: Math.round((calories * ratios.protein) / 4),
                    carbs: Math.round((calories * ratios.carbs) / 4),
                    fat: Math.round((calories * ratios.fat) / 9),
                    ratios: {
                        protein: Math.round(ratios.protein * 100),
                        carbs: Math.round(ratios.carbs * 100),
                        fat: Math.round(ratios.fat * 100)
                    }
                };
            }

            // Generate intelligent meal plan
            generateIntelligentMealPlan(totalCalories, macros) {
                const mealsCount = parseInt(this.userData.mealsPerDay) || 3;
                const mealDistribution = this.calculateMealDistribution(mealsCount);
                
                const meals = [];
                
                mealDistribution.forEach((ratio, index) => {
                    const mealCalories = Math.round(totalCalories * ratio);
                    const mealMacros = {
                        protein: Math.round(macros.protein * ratio),
                        carbs: Math.round(macros.carbs * ratio),
                        fat: Math.round(macros.fat * ratio)
                    };

                    const mealName = this.getMealName(index, mealsCount);
                    const suggestions = this.generateMealSuggestions(mealName, mealCalories, mealMacros);

                    meals.push({
                        name: mealName,
                        time: this.getMealTime(index, mealsCount),
                        calories: mealCalories,
                        macros: mealMacros,
                        suggestions: suggestions,
                        tips: this.getMealTips(mealName, this.userData.primaryGoal)
                    });
                });

                return meals;
            }

            // Calculate meal distribution
            calculateMealDistribution(mealsCount) {
                const distributions = {
                    2: [0.4, 0.6], // Bigger dinner
                    3: [0.3, 0.4, 0.3], // Standard
                    4: [0.25, 0.1, 0.35, 0.3], // Breakfast, snack, lunch, dinner
                    5: [0.25, 0.1, 0.3, 0.1, 0.25], // Added afternoon snack
                    6: [0.2, 0.1, 0.25, 0.1, 0.25, 0.1] // 6 small meals
                };

                return distributions[mealsCount] || distributions[3];
            }

            // Generate meal suggestions
            generateMealSuggestions(mealName, calories, macros) {
                const suggestions = [];
                const mealDB = this.nutritionDatabase.meals;
                
                // Find suitable meals from database
                const suitableMeals = mealDB[this.getMealCategory(mealName)] || [];
                
                suitableMeals.forEach(meal => {
                    if (Math.abs(meal.calories - calories) < calories * 0.3) { // Within 30%
                        suggestions.push({
                            name: meal.name,
                            ingredients: meal.ingredients,
                            calories: meal.calories,
                            protein: meal.protein || macros.protein,
                            suitability: this.calculateMealSuitability(meal, macros)
                        });
                    }
                });

                // Generate custom suggestions if not enough from database
                if (suggestions.length < 2) {
                    suggestions.push(...this.generateCustomMealSuggestions(mealName, calories, macros));
                }

                return suggestions.slice(0, 3); // Return top 3 suggestions
            }

            // Generate program overview
            generateProgramOverview() {
                return {
                    title: 'برنامه تمرینی و تغذیه‌ای شخصی‌سازی‌شده',
                    goal: this.getGoalDescription(this.userData.primaryGoal),
                    duration: '12 هفته',
                    frequency: `${this.userData.trainingDays} روز تمرین در هفته`,
                    approach: this.getProgramApproach(),
                    expectedResults: this.generateExpectedResults(),
                    keyPrinciples: this.getKeyPrinciples(),
                    successFactors: this.getSuccessFactors()
                };
            }

            // Get program approach
            getProgramApproach() {
                const goal = this.userData.primaryGoal;
                const somatotype = this.analysis.somatotype.name;
                const fitness = this.analysis.fitness.level;

                const approaches = {
                    'weight_loss': `رویکرد ترکیبی قدرت-هوازی با تمرکز بر سوزاندن چربی و حفظ عضله. 
                                   مناسب برای ${somatotype} با سطح ${fitness}.`,
                    'muscle_gain': `رویکرد هایپرتروفی با تمرکز بر حجم و پیشرفت تدریجی. 
                                    بهینه‌سازی شده برای ${somatotype} در سطح ${fitness}.`,
                    'strength': `رویکرد قدرت خالص با تمرکز بر حرکات اصلی و شدت بالا. 
                                طراحی شده برای ${somatotype} با تجربه ${fitness}.`
                };

                return approaches[goal] || `رویکرد جامع متناسب با ${somatotype} و سطح ${fitness}.`;
            }

            // Generate expected results
            generateExpectedResults() {
                const goal = this.userData.primaryGoal;
                const fitness = this.analysis.fitness.level;
                const somatotype = this.analysis.somatotype.name;

                const baseResults = {
                    'weight_loss': [
                        'کاهش 4-8 کیلو وزن در 12 هفته',
                        'کاهش 3-6% چربی بدن',
                        'بهبود 25-40% آمادگی قلبی',
                        'افزایش 15-25% قدرت عضلانی'
                    ],
                    'muscle_gain': [
                        'افزایش 2-5 کیلو عضله در 12 هفته',
                        'افزایش 20-35% قدرت',
                        'بهبود ترکیب بدن',
                        'افزایش حجم عضلانی قابل مشاهده'
                    ],
                    'strength': [
                        'افزایش 30-60% قدرت در حرکات اصلی',
                        'بهبود تکنیک و فرم',
                        'افزایش تراکم استخوان',
                        'بهبود عملکرد عصبی-عضلانی'
                    ]
                };

                let results = baseResults[goal] || [
                   'بهبود سلامت کلی',
                    'افزایش انرژی روزانه',
                    'بهبود خلق و خو',
                    'تقویت سیستم ایمنی'
                ];

                // Adjust results based on fitness level
                if (fitness === 'تازه‌کار') {
                    results = results.map(result => result.replace(/(\d+)-(\d+)/, (match, min, max) => {
                        const newMin = Math.round(min * 0.7);
                        const newMax = Math.round(max * 0.8);
                        return `${newMin}-${newMax}`;
                    }));
                } else if (fitness === 'پیشرفته') {
                    results = results.map(result => result.replace(/(\d+)-(\d+)/, (match, min, max) => {
                        const newMin = Math.round(min * 1.2);
                        const newMax = Math.round(max * 1.3);
                        return `${newMin}-${newMax}`;
                    }));
                }

                return results;
            }

            // Get key principles
            getKeyPrinciples() {
                return [
                    'پیشرفت تدریجی (Progressive Overload)',
                    'اصل خصوصیت (SAID Principle)',
                    'ریکاوری کافی برای رشد',
                    'تغذیه متناسب با هدف',
                    'ثبات و مداومت',
                    'گوش دادن به بدن'
                ];
            }

            // Get success factors
            getSuccessFactors() {
                return [
                    'مداومت در اجرای برنامه',
                    'ثبت پیشرفت و تنظیم برنامه',
                    'خواب کافی (7-9 ساعت)',
                    'مدیریت استرس',
                    'صبر و انتظار واقع‌بینانه',
                    'حمایت اجتماعی'
                ];
            }
        }

        // Enhanced Theme Management
        class AdvancedThemeManager {
            constructor() {
                this.currentTheme = 'light';
                this.init();
            }

            init() {
                // Detect system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    this.setTheme('dark');
                }
                
                // Listen for system changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    this.setTheme(event.matches ? 'dark' : 'light');
                });

                // Theme toggle button
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
            }

            setTheme(theme) {
                this.currentTheme = theme;
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            toggleTheme() {
                this.setTheme(this.currentTheme === 'dark' ? 'light' : 'dark');
            }
        }

        // Advanced Assessment Manager
        class IntelligentAssessmentManager {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 8;
                this.userData = {};
                this.analysisEngine = new AdvancedScientificEngine();
                this.validationErrors = [];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupRealTimeValidation();
                this.setupFormInteractions();
                this.updateProgress();
            }

            setupEventListeners() {
                // Navigation
                document.getElementById('startAssessment').addEventListener('click', () => this.startAssessment());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextStep());
                document.getElementById('prevBtn').addEventListener('click', () => this.prevStep());
                document.getElementById('generateBtn').addEventListener('click', () => this.generateProgram());

                // Priority sliders
                this.setupPrioritySliders();
                
                // Export functionality
                document.getElementById('exportData').addEventListener('click', () => this.exportResults());
            }

            setupPrioritySliders() {
                const sliders = ['strengthPriority', 'cardioPriority', 'flexibilityPriority', 'balancePriority', 'commitment'];
                sliders.forEach(sliderId => {
                    const slider = document.getElementById(sliderId);
                    if (slider) {
                        const valueSpan = document.getElementById(sliderId.replace('Priority', 'Value').replace('commitment', 'commitmentValue'));
                        
                        slider.addEventListener('input', () => {
                            if (valueSpan) valueSpan.textContent = slider.value;
                        });
                    }
                });
            }

            setupFormInteractions() {
                // Radio button interactions
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        // Remove selected class from siblings
                        const siblings = document.querySelectorAll(`input[name="${radio.name}"]`);
                        siblings.forEach(sibling => {
                            const card = sibling.closest('.option-card');
                            if (card) card.classList.remove('selected');
                        });
                        
                        // Add selected class to current
                        const card = radio.closest('.option-card');
                        if (card) card.classList.add('selected');
                    });
                });

                // Checkbox interactions
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const card = checkbox.closest('.option-card');
                        if (card) {
                            if (checkbox.checked) {
                                card.classList.add('selected');
                            } else {
                                card.classList.remove('selected');
                            }
                        }
                    });
                });
            }

            setupRealTimeValidation() {
                // BMI Calculator
                ['weight', 'height', 'age'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => this.updateBMI());
                    }
                });

                // Fitness Level Assessment
                ['pushupMax', 'plankTime', 'runningTime', 'restingHR'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => this.updateFitnessLevel());
                    }
                });

                // Body Type Analysis
                ['weightPattern', 'frameSize', 'appetitePattern', 'muscleGain'].forEach(name => {
                    document.querySelectorAll(`input[name="${name}"]`).forEach(input => {
                        input.addEventListener('change', () => this.updateBodyType());
                    });
                });

                // Goal Analysis
                document.querySelectorAll('input[name="primaryGoal"]').forEach(input => {
                    input.addEventListener('change', () => this.updateGoalAnalysis());
                });
            }

            updateBMI() {
                const weight = parseFloat(document.getElementById('weight').value);
                const height = parseFloat(document.getElementById('height').value);
                const age = parseInt(document.getElementById('age').value);
                const gender = document.querySelector('input[name="gender"]:checked')?.value;
                
                if (weight && height && age && gender) {
                    const bmiData = this.analysisEngine.calculateAdvancedBMI(weight, height, age, gender);
                    const bmrData = this.analysisEngine.calculatePrecisionBMR(weight, height, age, gender);
                    const bodyFatData = this.analysisEngine.estimateBodyFat(parseFloat(bmiData.bmi), age, gender);
                    
                    document.getElementById('bmiResult').classList.remove('hidden');
                    document.getElementById('bmiValue').textContent = bmiData.bmi;
                    document.getElementById('bmiCategory').textContent = bmiData.category;
                    document.getElementById('bmrEstimate').textContent = bmrData.bmr;
                    document.getElementById('bodyFatEstimate').textContent = bodyFatData.estimated + '%';
                    
                    // Color coding
                    const categoryEl = document.getElementById('bmiCategory');
                    categoryEl.className = 'text-lg font-bold';
                    if (bmiData.risk === 'کم') categoryEl.classList.add('text-green-600');
                    else if (bmiData.risk === 'متوسط') categoryEl.classList.add('text-yellow-600');
                    else categoryEl.classList.add('text-red-600');
                }
            }

            updateFitnessLevel() {
                const data = this.collectCurrentData();
                if (data.pushupMax || data.plankTime || data.runningTime || data.experience) {
                    const fitness = this.analysisEngine.assessAdvancedFitness(data);
                    const fitnessResult = document.getElementById('fitnessResult');
                    if (fitnessResult) {
                        fitnessResult.classList.remove('hidden');
                        document.getElementById('fitnessAnalysis').innerHTML = `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                    <div class="text-lg font-bold text-primary">${fitness.percentage}%</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">امتیاز کلی</div>
                                </div>
                                <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                    <div class="text-lg font-bold text-blue-600">${fitness.level}</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">سطح آمادگی</div>
                                </div>
                                <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                    <div class="text-lg font-bold text-green-600">${fitness.components.strength}/5</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">قدرت</div>
                                </div>
                                <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                    <div class="text-lg font-bold text-purple-600">${fitness.components.cardio}/5</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">استقامت</div>
                                </div>
                            </div>
                            <p class="text-sm mb-3">${fitness.description}</p>
                            <div class="text-xs">
                                <strong>نقاط قوت:</strong> ${fitness.strongestArea}<br>
                                <strong>نیاز به بهبود:</strong> ${fitness.weakestArea}
                            </div>
                        `;
                    }
                }
            }

            updateBodyType() {
                const data = this.collectCurrentData();
                if (data.weightPattern && data.frameSize && data.appetitePattern) {
                    const somatotype = this.analysisEngine.calculateSomatotype(data);
                    const bodyTypeResult = document.getElementById('bodyTypeResult');
                    if (bodyTypeResult) {
                        bodyTypeResult.classList.remove('hidden');
                        document.getElementById('bodyTypeAnalysis').innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="mb-4">
                                        <span class="text-gray-600 dark:text-gray-400">نوع بدن شما:</span>
                                        <span class="font-bold text-primary text-lg mr-2">${somatotype.name}</span>
                                        <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">اطمینان: ${somatotype.confidence}</span>
                                    </div>
                                    <p class="text-sm mb-4">${somatotype.description}</p>
                                    <div class="text-xs space-y-2">
                                        <div><strong>امتیاز ترکیبی:</strong></div>
                                        <div class="grid grid-cols-3 gap-2">
                                            <div>اندومورف: ${somatotype.scores.endomorphy}</div>
                                            <div>مزومورف: ${somatotype.scores.mesomorphy}</div>
                                            <div>اکتومورف: ${somatotype.scores.ectomorphy}</div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h6 class="font-semibold mb-3">ویژگی‌های شما:</h6>
                                    <ul class="text-sm space-y-1 mb-4">
                                        ${somatotype.characteristics.map(char => `<li>• ${char}</li>`).join('')}
                                    </ul>
                                    <h6 class="font-semibold mb-2">مزایا:</h6>
                                    <ul class="text-sm space-y-1 text-green-600 dark:text-green-400">
                                        ${somatotype.advantages.map(adv => `<li>✓ ${adv}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            updateGoalAnalysis() {
                const goal = document.querySelector('input[name="primaryGoal"]:checked')?.value;
                if (goal) {
                    const goalDescriptions = {
                        'weight_loss': 'کاهش وزن و سوزاندن چربی از طریق ترکیب تمرینات قدرتی و هوازی',
                        'muscle_gain': 'افزایش حجم عضلانی از طریق تمرینات هایپرتروفی و تغذیه مناسب',
                        'strength': 'افزایش قدرت حداکثر از طریق تمرینات پاورلیفتینگ و المپیک',
                        'endurance': 'بهبود استقامت قلبی-عروقی و عضلانی',
                        'martial_arts': 'توسعه قدرت عملکردی، سرعت و چابکی',
                        'flexibility': 'بهبود دامنه حرکتی و انعطاف‌پذیری',
                        'athletic': 'بهبود عملکرد در ورزش خاص',
                        'general_health': 'بهبود سلامت کلی و کیفیت زندگی',
                        'rehabilitation': 'ریکاوری از آسیب و تقویت نقاط ضعف'
                    };

                    const goalAnalysis = document.getElementById('goalAnalysis');
                    if (goalAnalysis && goalDescriptions[goal]) {
                        goalAnalysis.classList.remove('hidden');
                        document.getElementById('goalAnalysisContent').innerHTML = `
                            <div class="p-4 bg-white dark:bg-gray-800 rounded-lg">
                                <h6 class="font-semibold mb-2">${this.getGoalTitle(goal)}</h6>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${goalDescriptions[goal]}</p>
                            </div>
                        `;
                    }
                }
            }

            getGoalTitle(goal) {
                const titles = {
                    'weight_loss': '🔥 کاهش وزن',
                    'muscle_gain': '💪 افزایش عضله',
                    'strength': '🏋️ افزایش قدرت',
                    'endurance': '🏃 بهبود استقامت',
                    'martial_arts': '🥋 هنرهای رزمی',
                    'flexibility': '🤸 انعطاف‌پذیری',
                    'athletic': '⚽ عملکرد ورزشی',
                    'general_health': '❤️ سلامت کلی',
                    'rehabilitation': '🩹 بازتوانی'
                };
                return titles[goal] || goal;
            }

            collectCurrentData() {
                const data = {};
                
                // Get all form inputs
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        if (!data[input.name]) data[input.name] = [];
                        if (input.checked) data[input.name].push(input.value);
                    } else if (input.type === 'radio') {
                        if (input.checked) data[input.name] = input.value;
                    } else if (input.id) {
                        data[input.id] = input.value;
                    }
                });

                return data;
            }

            startAssessment() {
                document.getElementById('welcomeSection').classList.add('hidden');
                document.getElementById('assessmentForm').classList.remove('hidden');
                this.showStep(1);
            }

            nextStep() {
                if (this.validateCurrentStep()) {
                    this.userData = { ...this.userData, ...this.collectCurrentData() };
                    
                    if (this.currentStep === this.totalSteps) {
                        this.showFinalAnalysis();
                    } else {
                        this.currentStep++;
                        this.showStep(this.currentStep);
                    }
                }
            }

            prevStep() {
                this.currentStep--;
                this.showStep(this.currentStep);
            }

            showStep(step) {
                // Hide all steps
                for (let i = 1; i <= this.totalSteps; i++) {
                    const stepEl = document.getElementById(`step${i}`);
                    if (stepEl) stepEl.classList.add('hidden');
                }
                
                // Show current step
                const currentStepEl = document.getElementById(`step${step}`);
                if (currentStepEl) currentStepEl.classList.remove('hidden');
                
                // Update navigation
                document.getElementById('prevBtn').classList.toggle('hidden', step === 1);
                document.getElementById('nextBtn').classList.toggle('hidden', step === this.totalSteps);
                document.getElementById('generateBtn').classList.toggle('hidden', step !== this.totalSteps);
                
                this.updateProgress();
                document.getElementById('assessmentForm').scrollIntoView({ behavior: 'smooth' });
            }

            updateProgress() {
                const progress = (this.currentStep / this.totalSteps) * 100;
                const progressBar = document.getElementById('progressBar');
                const currentStepEl = document.getElementById('currentStep');
                const progressPercent = document.getElementById('progressPercent');
                
                if (progressBar) progressBar.style.width = progress + '%';
                if (currentStepEl) currentStepEl.textContent = this.currentStep;
                if (progressPercent) progressPercent.textContent = Math.round(progress) + '%';
            }

            validateCurrentStep() {
                this.validationErrors = [];
                const requiredFields = this.getRequiredFields(this.currentStep);

                requiredFields.forEach(field => {
                    const element = field.type === 'input' ? 
                        document.getElementById(field.id) : 
                        document.querySelector(`input[name="${field.name}"]:checked`) ||
                        document.querySelector(`input[name="${field.name}"]`);

                    if (!element || !element.value || (field.type === 'radio' && !document.querySelector(`input[name="${field.name}"]:checked`))) {
                        this.validationErrors.push(field.label);
                        if (element) {
                            element.classList.add('error-input');
                            setTimeout(() => element.classList.remove('error-input'), 3000);
                        }
                    }
                });

                if (this.validationErrors.length > 0) {
                    this.showError(`لطفاً این موارد را تکمیل کنید: ${this.validationErrors.join('، ')}`);
                    return false;
                }

                return this.validateSpecificStep(this.currentStep);
            }

            getRequiredFields(step) {
                const requiredFieldsMap = {
                    1: [
                        { type: 'input', id: 'age', label: 'سن' },
                        { type: 'radio', name: 'gender', label: 'جنسیت' },
                        { type: 'input', id: 'height', label: 'قد' },
                        { type: 'input', id: 'weight', label: 'وزن فعلی' },
                        { type: 'input', id: 'targetWeight', label: 'وزن هدف' }
                    ],
                    2: [
                        { type: 'radio', name: 'flexibility', label: 'انعطاف‌پذیری' },
                        { type: 'radio', name: 'experience', label: 'سابقه ورزشی' }
                    ],
                    3: [
                        { type: 'radio', name: 'weightPattern', label: 'الگوی وزن' },
                        { type: 'radio', name: 'frameSize', label: 'ساختار بدن' },
                        { type: 'radio', name: 'appetitePattern', label: 'الگوی اشتها' }
                    ],
                    4: [
                        { type: 'radio', name: 'primaryGoal', label: 'هدف اصلی' },
                        { type: 'input', id: 'trainingDays', label: 'روزهای تمرین' },
                        { type: 'input', id: 'sessionLength', label: 'مدت جلسه' }
                    ],
                    5: [
                        { type: 'radio', name: 'environment', label: 'محیط تمرین' }
                    ],
                    6: [
                        { type: 'radio', name: 'dailyActivity', label: 'فعالیت روزانه' }
                    ],
                    7: [],
                    8: []
                };

                return requiredFieldsMap[step] || [];
            }

            validateSpecificStep(step) {
                switch(step) {
                    case 1:
                        const age = parseInt(document.getElementById('age').value);
                        if (age < 15 || age > 80) {
                            this.showError('سن باید بین 15 تا 80 سال باشد');
                            return false;
                        }
                        
                        const weight = parseFloat(document.getElementById('weight').value);
                        const targetWeight = parseFloat(document.getElementById('targetWeight').value);
                        const weightDiff = Math.abs(weight - targetWeight);
                        if (weightDiff > weight * 0.4) {
                            this.showError('تفاوت وزن فعلی و هدف باید واقع‌بینانه باشد (حداکثر 40% وزن فعلی)');
                            return false;
                        }
                        break;
                        
                    case 4:
                        const trainingDays = parseInt(document.getElementById('trainingDays').value);
                        const sessionLength = parseInt(document.getElementById('sessionLength').value);
                        if (trainingDays && sessionLength && trainingDays * sessionLength > 720) {
                            this.showError('حجم تمرین هفتگی بیش از حد مجاز است (حداکثر 12 ساعت در هفته)');
                            return false;
                        }
                        break;
                }
                
                return true;
            }

            showFinalAnalysis() {
                const data = this.collectCurrentData();
                this.userData = { ...this.userData, ...data };
                
                // Perform preliminary analysis for preview
                const analysis = this.analysisEngine.performCompleteAnalysis(this.userData);
                
                const finalAnalysis = document.getElementById('finalAnalysis');
                if (finalAnalysis) {
                    finalAnalysis.classList.remove('hidden');
                    document.getElementById('analysisPreview').innerHTML = `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                <div class="text-lg font-bold text-primary">${analysis.metabolic.bmi.bmi}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">BMI</div>
                            </div>
                            <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                <div class="text-lg font-bold text-blue-600">${analysis.metabolic.tdee.correctedTDEE}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">کالری روزانه</div>
                            </div>
                            <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                <div class="text-lg font-bold text-green-600">${analysis.somatotype.name}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">نوع بدن</div>
                            </div>
                            <div class="text-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                <div class="text-lg font-bold text-purple-600">${analysis.fitness.level}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">سطح آمادگی</div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                آماده تولید برنامه علمی شخصی‌سازی‌شده براساس ${Object.keys(this.userData).length} پارامتر
                            </p>
                            <div class="flex justify-center space-x-4 space-x-reverse text-xs">
                                <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">
                                    ${analysis.risks.overallRisk === 'کم' ? '✅ ایمن' : '⚠️ نیاز به احتیاط'}
                                </span>
                                <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">
                                    🎯 ${analysis.goals.feasibility}
                                </span>
                                <span class="bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded">
                                    ⏱️ ${analysis.goals.timeline}
                                </span>
                            </div>
                        </div>
                    `;
                }
            }

            generateProgram() {
                this.showLoadingState();
                
                // Simulate processing time for better UX
                setTimeout(() => {
                    try {
                        this.userData = { ...this.userData, ...this.collectCurrentData() };
                        
                        // Perform complete analysis
                        const analysis = this.analysisEngine.performCompleteAnalysis(this.userData);
                        
                        // Generate comprehensive program
                        const programGenerator = new IntelligentProgramGenerator(this.userData, analysis);
                        const completeProgram = programGenerator.generateCompleteProgram();

                        // Display results
                        this.displayResults(analysis, completeProgram);
                        
                    } catch (error) {
                        console.error('Error generating program:', error);
                        this.showError('خطا در تولید برنامه. لطفاً دوباره تلاش کنید.');
                    }
                }, 2000);
            }

            showLoadingState() {
                const generateBtn = document.getElementById('generateBtn');
                if (generateBtn) {
                    generateBtn.innerHTML = `
                        <div class="flex items-center justify-center">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                            در حال تولید برنامه هوشمند...
                        </div>
                    `;
                    generateBtn.disabled = true;
                }
            }

            displayResults(analysis, program) {
                const dashboardEl = document.getElementById('resultsDashboard');
                
                dashboardEl.innerHTML = `
                    <div class="space-y-8">
                        <!-- Success Header -->
                        <div class="text-center animate-fade-in">
                            <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <h2 class="text-3xl font-bold mb-4 bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                                🎉 برنامه علمی شما آماده است!
                            </h2>
                            <p class="text-gray-600 dark:text-gray-400 text-lg">
                                تحلیل جامع ${Object.keys(this.userData).length} پارامتر و تولید برنامه منحصر به فرد
                            </p>
                        </div>

                        <!-- Key Metrics -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            ${this.generateKeyMetricsCards(analysis)}
                        </div>

                        <!-- Main Dashboard -->
                        <div class="bg-white dark:bg-dark-card rounded-3xl shadow-2xl overflow-hidden">
                            <!-- Tab Navigation -->
                            <div class="flex flex-wrap border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
                                <button class="tab-btn tab-active px-6 py-4 font-semibold transition-all duration-300" data-tab="overview">
                                    📊 خلاصه کلی
                                </button>
                                <button class="tab-btn px-6 py-4 font-semibold transition-all duration-300" data-tab="workout">
                                    💪 برنامه تمرینی
                                </button>
                                <button class="tab-btn px-6 py-4 font-semibold transition-all duration-300" data-tab="nutrition">
                                    🥗 برنامه تغذیه
                                </button>
                                <button class="tab-btn px-6 py-4 font-semibold transition-all duration-300" data-tab="analysis">
                                    🧬 تحلیل علمی
                                </button>
                                <button class="tab-btn px-6 py-4 font-semibold transition-all duration-300" data-tab="progress">
                                    📈 پیشرفت
                                </button>
                            </div>

                            <!-- Tab Content -->
                            <div class="p-8">
                                <div id="tab-overview" class="tab-content">
                                    ${this.generateOverviewContent(analysis, program)}
                                </div>
                                <div id="tab-workout" class="tab-content hidden">
                                    ${this.generateWorkoutContent(program.weekly)}
                                </div>
                                <div id="tab-nutrition" class="tab-content hidden">
                                    ${this.generateNutritionContent(program.nutrition)}
                                </div>
                                <div id="tab-analysis" class="tab-content hidden">
                                    ${this.generateAnalysisContent(analysis)}
                                </div>
                                <div id="tab-progress" class="tab-content hidden">
                                    ${this.generateProgressContent(program.progression, program.monitoring)}
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center space-x-4 space-x-reverse">
                            <button id="restartBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 shadow-lg">
                                🔄 تحلیل مجدد
                            </button>
                            <button id="downloadBtn" class="gradient-primary text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                                💾 دانلود برنامه کامل
                            </button>
                            <button id="shareBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 shadow-lg">
                                📤 اشتراک‌گذاری
                            </button>
                        </div>
                    </div>
                `;

                this.setupResultsInteraction(analysis, program);
                document.getElementById('assessmentForm').classList.add('hidden');
                document.getElementById('resultsDashboard').classList.remove('hidden');
                document.getElementById('exportData').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            generateKeyMetricsCards(analysis) {
                return `
                    <div class="metric-card p-6 rounded-2xl text-center card-shadow">
                        <div class="w-12 h-12 gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white font-bold text-sm">BMI</span>
                        </div>
                        <h4 class="font-semibold text-primary mb-2">شاخص توده بدنی</h4>
                        <p class="text-2xl font-bold">${analysis.metabolic.bmi.bmi}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${analysis.metabolic.bmi.category}</p>
                        <div class="mt-2 text-xs ${analysis.metabolic.bmi.risk === 'کم' ? 'text-green-600' : 'text-orange-600'}">
                            ${analysis.metabolic.bmi.recommendation}
                        </div>
                    </div>
                    
                    <div class="metric-card p-6 rounded-2xl text-center card-shadow">
                        <div class="w-12 h-12 gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-xl">🔥</span>
                        </div>
                        <h4 class="font-semibold text-primary mb-2">متابولیسم</h4>
                        <p class="text-2xl font-bold">${analysis.metabolic.tdee.correctedTDEE}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">کالری روزانه</p>
                        <div class="mt-2 text-xs text-blue-600">
                            BMR: ${analysis.metabolic.bmr.bmr} کالری
                        </div>
                    </div>
                    
                    <div class="metric-card p-6 rounded-2xl text-center card-shadow">
                        <div class="w-12 h-12 gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-xl">🧬</span>
                        </div>
                        <h4 class="font-semibold text-primary mb-2">نوع بدن</h4>
                        <p class="text-lg font-bold">${analysis.somatotype.name}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">سوماتوتایپ</p>
                        <div class="mt-2 text-xs text-purple-600">
                            اطمینان: ${analysis.somatotype.confidence}
                        </div>
                    </div>
                    
                    <div class="metric-card p-6 rounded-2xl text-center card-shadow">
                        <div class="w-12 h-12 gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-xl">💪</span>
                        </div>
                        <h4 class="font-semibold text-primary mb-2">آمادگی جسمانی</h4>
                        <p class="text-lg font-bold">${analysis.fitness.level}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${analysis.fitness.percentage}% امتیاز</p>
                        <div class="mt-2 text-xs text-green-600">
                            ${analysis.fitness.strongestArea}: قوی‌ترین نقطه
                        </div>
                    </div>
                `;
            }

            generateOverviewContent(analysis, program) {
                return `
                    <div class="space-y-8">
                        <!-- Program Summary -->
                        <div class="gradient-card p-6 rounded-2xl">
                            <h3 class="text-xl font-bold mb-4 text-center">${program.overview.title}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                                <div>
                                    <div class="font-semibold text-primary">هدف</div>
                                    <div class="text-sm">${program.overview.goal}</div>
                                </div>
                                <div>
                                    <div class="font-semibold text-primary">مدت</div>
                                    <div class="text-sm">${program.overview.duration}</div>
                                </div>
                                <div>
                                    <div class="font-semibold text-primary">تکرار</div>
                                    <div class="text-sm">${program.overview.frequency}</div>
                                </div>
                                <div>
                                    <div class="font-semibold text-primary">رویکرد</div>
                                    <div class="text-sm">علمی و شخصی</div>
                                </div>
                            </div>
                        </div>

                        <!-- Key Recommendations -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="metric-card p-6 rounded-2xl">
                                <h4 class="font-semibold text-lg mb-4 text-primary">🏋️ توصیه‌های تمرینی فوری</h4>
                                <ul class="space-y-2 text-sm">
                                    ${analysis.recommendations.immediate.map(rec => `<li class="flex items-start"><span class="text-green-500 mr-2">✓</span>${rec}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="metric-card p-6 rounded-2xl">
                                <h4 class="font-semibold text-lg mb-4 text-primary">🥗 توصیه‌های تغذیه‌ای</h4>
                                <ul class="space-y-2 text-sm">
                                    ${analysis.goals.recommendations.nutrition.map(rec => `<li class="flex items-start"><span class="text-blue-500 mr-2">✓</span>${rec}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- Expected Results -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="font-semibold text-lg mb-4 text-primary">🎯 نتایج مورد انتظار</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5 class="font-medium mb-3">12 هفته اول:</h5>
                                    <ul class="space-y-1 text-sm">
                                        ${program.overview.expectedResults.slice(0, 2).map(result => `<li>• ${result}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-medium mb-3">نتایج طولانی‌مدت:</h5>
                                    <ul class="space-y-1 text-sm">
                                        ${program.overview.expectedResults.slice(2).map(result => `<li>• ${result}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Assessment -->
                        ${analysis.risks.riskFactors.length > 0 ? `
                        <div class="border-2 border-orange-200 dark:border-orange-700 bg-orange-50 dark:bg-orange-900/20 p-6 rounded-2xl">
                            <h4 class="font-semibold text-lg mb-4 text-orange-700 dark:text-orange-300">⚠️ نکات ایمنی</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-medium mb-2">عوامل خطر:</h5>
                                    <ul class="text-sm space-y-1">
                                        ${analysis.risks.riskFactors.map(risk => `<li>• ${risk}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-medium mb-2">توصیه‌های ایمنی:</h5>
                                    <ul class="text-sm space-y-1">
                                        ${analysis.risks.recommendations.map(rec => `<li>• ${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Success Factors -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="font-semibold text-lg mb-4 text-primary">🏆 کلیدهای موفقیت</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${program.overview.successFactors.map(factor => `
                                    <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <span class="text-green-500 mr-2">🎯</span>
                                        <span class="text-sm">${factor}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            generateWorkoutContent(weeklyProgram) {
                let content = '<div class="space-y-6">';
                
                // Program Overview
                content += `
                    <div class="gradient-card p-6 rounded-2xl text-center">
                        <h3 class="text-xl font-bold mb-4">📋 خلاصه برنامه تمرینی</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <div class="font-semibold">روزهای تمرین</div>
                                <div>${weeklyProgram.daysPerWeek} روز</div>
                            </div>
                            <div>
                                <div class="font-semibold">مدت جلسه</div>
                                <div>${weeklyProgram.sessionLength} دقیقه</div>
                            </div>
                            <div>
                                <div class="font-semibold">حجم هفتگی</div>
                                <div>${weeklyProgram.weeklyVolume} واحد</div>
                            </div>
                            <div>
                                <div class="font-semibold">روزهای استراحت</div>
                                <div>${weeklyProgram.restDays} روز</div>
                            </div>
                        </div>
                    </div>
                `;

                // Weekly Schedule
                weeklyProgram.days.forEach((day, index) => {
                    content += `
                        <div class="metric-card p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-primary">روز ${index + 1}: ${day.name}</h4>
                                <div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
                                    <span>⏱️ ${day.duration} دقیقه</span>
                                    <span>🎯 ${day.focus}</span>
                                    <span>💪 شدت: ${day.intensity}%</span>
                                </div>
                            </div>
                            
                            <!-- Warmup -->
                            <div class="mb-4">
                                <h5 class="font-medium mb-2 text-yellow-600 flex items-center">
                                    <span class="mr-2">🔥</span>
                                    گرم‌کردن (10-15 دقیقه)
                                </h5>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                                    ${day.warmup.map(w => `<div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded flex items-center"><span class="mr-1">•</span>${w.name} - ${w.duration}</div>`).join('')}
                                </div>
                            </div>

                            <!-- Main Exercises -->
                            <div class="mb-4">
                                <h5 class="font-medium mb-3 text-primary flex items-center">
                                    <span class="mr-2">💪</span>
                                    تمرینات اصلی
                                </h5>
                                <div class="space-y-3">
                                    ${day.mainExercises.map((ex, i) => `
                                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div class="flex justify-between items-start mb-2">
                                                <h6 class="font-medium text-gray-900 dark:text-gray-100">${i + 1}. ${ex.name}</h6>
                                                <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">${ex.muscle || ex.type}</span>
                                            </div>
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm mb-2">
                                                <div><span class="font-medium">ست:</span> ${ex.sets}</div>
                                                <div><span class="font-medium">تکرار:</span> ${ex.reps || ex.duration}</div>
                                                <div><span class="font-medium">استراحت:</span> ${ex.rest || 'بدون'}</div>
                                                <div><span class="font-medium">شدت:</span> ${ex.intensity || 'متوسط'}</div>
                                            </div>
                                            ${ex.form ? `<div class="text-xs text-blue-600 dark:text-blue-400 mb-1"><strong>فرم:</strong> ${ex.form}</div>` : ''}
                                            ${ex.notes ? `<div class="text-xs text-gray-600 dark:text-gray-400"><strong>نکته:</strong> ${ex.notes}</div>` : ''}
                                            ${ex.progression ? `<div class="text-xs text-green-600 dark:text-green-400"><strong>پیشرفت:</strong> ${ex.progression}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Cooldown -->
                            <div class="mb-4">
                                <h5 class="font-medium mb-2 text-blue-600 flex items-center">
                                    <span class="mr-2">❄️</span>
                                    سرد کردن (10 دقیقه)
                                </h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                    ${day.cooldown.map(c => `<div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded flex items-center"><span class="mr-1">•</span>${c.name} - ${c.duration}</div>`).join('')}
                                </div>
                            </div>

                            ${day.notes && day.notes.length > 0 ? `
                                <div class="p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-700">
                                    <h6 class="font-medium text-amber-700 dark:text-amber-300 mb-1 flex items-center">
                                        <span class="mr-1">⚠️</span>نکات مهم:
                                    </h6>
                                    <ul class="text-sm text-amber-600 dark:text-amber-400 space-y-1">
                                        ${day.notes.map(note => `<li>• ${note}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                content += '</div>';
                return content;
            }

            generateNutritionContent(nutritionPlan) {
                return `
                    <div class="space-y-6">
                        <!-- Nutrition Overview -->
                        <div class="gradient-card p-6 rounded-2xl text-center">
                            <h3 class="text-xl font-bold mb-4">🍽️ خلاصه برنامه تغذیه</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <div class="text-2xl font-bold text-primary">${nutritionPlan.summary.dailyCalories}</div>
                                    <div class="text-sm">کالری روزانه</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-red-600">${nutritionPlan.summary.macros.protein}g</div>
                                    <div class="text-sm">پروتئین (${nutritionPlan.summary.macros.ratios.protein}%)</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-yellow-600">${nutritionPlan.summary.macros.carbs}g</div>
                                    <div class="text-sm">کربوهیدرات (${nutritionPlan.summary.macros.ratios.carbs}%)</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-600">${nutritionPlan.summary.macros.fat}g</div>
                                    <div class="text-sm">چربی (${nutritionPlan.summary.macros.ratios.fat}%)</div>
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                                نوع متابولیک: <span class="font-semibold">${nutritionPlan.summary.metabolicType}</span> |
                                رویکرد: <span class="font-semibold">${nutritionPlan.summary.approach}</span>
                            </div>
                        </div>

                        <!-- Daily Meal Plan -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                <span class="mr-2">🍽️</span>برنامه وعده‌های غذایی روزانه
                            </h4>
                            <div class="space-y-4">
                                ${nutritionPlan.detailed.meals.map(meal => `
                                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                                        <div class="flex justify-between items-center mb-3">
                                            <h5 class="font-medium text-lg">${meal.name}</h5>
                                            <div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
                                                <span>⏰ ${meal.time}</span>
                                                <span>🔥 ${meal.calories} کالری</span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-4 text-sm mb-3">
                                            <div class="text-center p-2 bg-red-50 dark:bg-red-900/20 rounded">
                                                <div class="font-bold text-red-600">${meal.macros.protein}g</div>
                                                <div class="text-xs">پروتئین</div>
                                            </div>
                                            <div class="text-center p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded">
                                                <div class="font-bold text-yellow-600">${meal.macros.carbs}g</div>
                                                <div class="text-xs">کربوهیدرات</div>
                                            </div>
                                            <div class="text-center p-2 bg-green-50 dark:bg-green-900/20 rounded">
                                                <div class="font-bold text-green-600">${meal.macros.fat}g</div>
                                                <div class="text-xs">چربی</div>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="font-medium mb-2">پیشنهادات غذایی:</h6>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                ${meal.suggestions.map(suggestion => `
                                                    <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-sm">
                                                        <div class="font-medium">${suggestion.name}</div>
                                                        <div class="text-xs text-gray-600 dark:text-gray-400">
                                                            ${suggestion.ingredients ? suggestion.ingredients.join('، ') : 'مناسب برای هدف شما'}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        ${meal.tips && meal.tips.length > 0 ? `
                                            <div class="mt-3 p-2 bg-blue-50 dark:bg-blue-900/20 rounded">
                                                <h6 class="font-medium text-blue-700 dark:text-blue-300 text-sm mb-1">💡 نکات:</h6>
                                                <ul class="text-xs text-blue-600 dark:text-blue-400">
                                                    ${meal.tips.map(tip => `<li>• ${tip}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Supplements & Hydration -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="metric-card p-6 rounded-2xl">
                                <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                    <span class="mr-2">💊</span>برنامه مکمل‌ها
                                </h4>
                                <div class="space-y-3">
                                    ${nutritionPlan.detailed.supplements.essential.concat(nutritionPlan.detailed.supplements.goalSpecific).map(supp => `
                                        <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <span class="font-medium">${supp.name}</span>
                                            <div class="text-right text-sm">
                                                <div class="font-medium">${supp.dosage}</div>
                                                <div class="text-gray-500 text-xs">${supp.timing}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="metric-card p-6 rounded-2xl">
                                <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                    <span class="mr-2">💧</span>برنامه آبرسانی
                                </h4>
                                <div class="text-center mb-4">
                                    <div class="text-3xl font-bold text-blue-600">${nutritionPlan.detailed.hydration.dailyGoal}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">هدف روزانه</div>
                                </div>
                                <div class="space-y-2 text-sm">
                                    ${nutritionPlan.detailed.hydration.recommendations.map(rec => `
                                        <div class="flex items-center p-2 bg-blue-50 dark:bg-blue-900/20 rounded">
                                            <span class="text-blue-500 mr-2">💧</span>
                                            <span>${rec}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Nutrition Guidelines -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                <span class="mr-2">📋</span>راهنمای تغذیه
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5 class="font-medium mb-3 text-green-600">✅ توصیه می‌شود:</h5>
                                    <ul class="space-y-1 text-sm">
                                        ${nutritionPlan.guidelines.recommended?.map(item => `<li>• ${item}</li>`).join('') || '<li>• غذاهای طبیعی و تازه</li><li>• پروتئین در هر وعده</li>'}
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-medium mb-3 text-red-600">❌ اجتناب کنید:</h5>
                                    <ul class="space-y-1 text-sm">
                                        ${nutritionPlan.guidelines.avoid?.map(item => `<li>• ${item}</li>`).join('') || '<li>• غذاهای فرآوری‌شده</li><li>• شکر اضافی</li>'}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            generateAnalysisContent(analysis) {
                return `
                    <div class="space-y-6">
                        <!-- Scientific Analysis Header -->
                        <div class="gradient-card p-6 rounded-2xl">
                            <h3 class="text-xl font-bold text-center mb-4">🔬 تحلیل علمی جامع</h3>
                            <p class="text-center text-sm opacity-90">
                                براساس آخرین یافته‌های علمی و استانداردهای بین‌المللی
                            </p>
                        </div>

                        <!-- Metabolic Analysis -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                <span class="mr-2">⚡</span>تحلیل متابولیک
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5 class="font-medium mb-3">شاخص‌های پایه:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>BMI:</span>
                                            <span class="font-bold">${analysis.metabolic.bmi.bmi} (${analysis.metabolic.bmi.category})</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>BMR:</span>
                                            <span class="font-bold">${analysis.metabolic.bmr.bmr} کالری</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>TDEE:</span>
                                            <span class="font-bold">${analysis.metabolic.tdee.correctedTDEE} کالری</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>درصد چربی تخمینی:</span>
                                            <span class="font-bold">${analysis.metabolic.bodyFat.estimated}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-medium mb-3">ترکیب بدن:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>توده عضلانی:</span>
                                            <span class="font-bold text-green-600">${analysis.metabolic.bodyComposition.leanBodyMass} کیلو</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>توده چربی:</span>
                                            <span class="font-bold text-orange-600">${analysis.metabolic.bodyComposition.fatMass} کیلو</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>کارایی متابولیک:</span>
                                            <span class="font-bold text-blue-600">${analysis.metabolic.metabolicProfile.efficiency.category}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Somatotype Analysis -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                <span class="mr-2">🧬</span>تحلیل نوع بدن (سوماتوتایپ)
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5 class="font-medium mb-3">${analysis.somatotype.name}</h5>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${analysis.somatotype.description}</p>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between">
                                            <span>اندومورف:</span>
                                            <span class="font-bold">${analysis.somatotype.scores.endomorphy}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>مزومورف:</span>
                                            <span class="font-bold">${analysis.somatotype.scores.mesomorphy}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>اکتومورف:</span>
                                            <span class="font-bold">${analysis.somatotype.scores.ectomorphy}</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-medium mb-3">توصیه‌های تمرینی:</h5>
                                    <ul class="text-sm space-y-1">
                                        ${analysis.somatotype.recommendations.training.map(rec => `<li>• ${rec}</li>`).join('')}
                                    </ul>
                                    <h5 class="font-medium mb-2 mt-4">توصیه‌های تغذیه‌ای:</h5>
                                    <ul class="text-sm space-y-1">
                                        ${analysis.somatotype.recommendations.nutrition.map(rec => `<li>• ${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Fitness Assessment -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                <span class="mr-2">💪</span>ارزیابی آمادگی جسمانی
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="text-center p-4 bg-primary/10 rounded-lg mb-4">
                                        <div class="text-3xl font-bold text-primary">${analysis.fitness.percentage}%</div>
                                        <div class="text-sm">${analysis.fitness.level}</div>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${analysis.fitness.description}</p>
                                </div>
                                <div>
                                    <h5 class="font-medium mb-3">جزئیات امتیازات:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between items-center">
                                            <span>قدرت:</span>
                                            <div class="flex items-center">
                                                <div class="w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-2">
                                                    <div class="bg-red-500 h-2 rounded-full" style="width: ${(analysis.fitness.components.strength/5)*100}%"></div>
                                                </div>
                                                <span class="font-bold">${analysis.fitness.components.strength}/5</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>مرکز بدن:</span>
                                            <div class="flex items-center">
                                                <div class="w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-2">
                                                    <div class="bg-yellow-500 h-2 rounded-full" style="width: ${(analysis.fitness.components.core/5)*100}%"></div>
                                                </div>
                                                <span class="font-bold">${analysis.fitness.components.core}/5</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>استقامت:</span>
                                            <div class="flex items-center">
                                                <div class="w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-2">
                                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${(analysis.fitness.components.cardio/5)*100}%"></div>
                                                </div>
                                                <span class="font-bold">${analysis.fitness.components.cardio}/5</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>انعطاف‌پذیری:</span>
                                            <div class="flex items-center">
                                                <div class="w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-2">
                                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${(analysis.fitness.components.flexibility/5)*100}%"></div>
                                                </div>
                                                <span class="font-bold">${analysis.fitness.components.flexibility}/5</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Goal Analysis -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                <span class="mr-2">🎯</span>تحلیل هدف
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                    <div class="font-semibold text-green-700 dark:text-green-300">امکان‌پذیری</div>
                                    <div class="text-lg font-bold text-green-600">${analysis.goals.feasibility}</div>
                                </div>
                                <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                    <div class="font-semibold text-blue-700 dark:text-blue-300">زمان‌بندی</div>
                                    <div class="text-sm font-bold text-blue-600">${analysis.goals.timeline}</div>
                                </div>
                                <div class="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                    <div class="font-semibold text-purple-700 dark:text-purple-300">تغییر مورد نیاز</div>
                                    <div class="text-sm font-bold text-purple-600">${analysis.goals.currentVsTarget.difference} کیلو</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <div>
                                    <h5 class="font-medium mb-2 text-green-600">مزایای شما:</h5>
                                    <ul class="text-sm space-y-1">
                                        ${analysis.goals.advantages.map(adv => `<li>• ${adv}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-medium mb-2 text-orange-600">چالش‌ها:</h5>
                                    <ul class="text-sm space-y-1">
                                        ${analysis.goals.challenges.map(challenge => `<li>• ${challenge}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            generateProgressContent(progressionPlan, monitoringPlan) {
                return `
                    <div class="space-y-6">
                        <!-- Progress Timeline -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                <span class="mr-2">📈</span>مسیر پیشرفت 12 هفته‌ای
                            </h4>
                            <div class="space-y-4">
                                <div class="flex items-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-r-4 border-green-500">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold mr-4 flex-shrink-0">1</div>
                                    <div>
                                        <h5 class="font-medium text-green-700 dark:text-green-300">هفته‌های 1-2: آشنایی و سازگاری</h5>
                                        <p class="text-sm text-green-600 dark:text-green-400">یادگیری حرکات، ایجاد عادت، بهبود انرژی و کیفیت خواب</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-r-4 border-blue-500">
                                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold mr-4 flex-shrink-0">2</div>
                                    <div>
                                        <h5 class="font-medium text-blue-700 dark:text-blue-300">هفته‌های 3-4: پیشرفت اولیه</h5>
                                        <p class="text-sm text-blue-600 dark:text-blue-400">افزایش قدرت 15-25%، بهبود استقامت، تغییرات اندک در ترکیب بدن</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border-r-4 border-orange-500">
                                    <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold mr-4 flex-shrink-0">3</div>
                                    <div>
                                        <h5 class="font-medium text-orange-700 dark:text-orange-300">هفته‌های 5-8: تغییرات محسوس</h5>
                                        <p class="text-sm text-orange-600 dark:text-orange-400">تغییر قابل مشاهده در ترکیب بدن، افزایش 30-50% قدرت، بهبود فرم</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border-r-4 border-purple-500">
                                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold mr-4 flex-shrink-0">4</div>
                                    <div>
                                        <h5 class="font-medium text-purple-700 dark:text-purple-300">هفته‌های 9-12: نتایج نهایی</h5>
                                        <p class="text-sm text-purple-600 dark:text-purple-400">رسیدن به اهداف اصلی، ایجاد عادات پایدار، آمادگی برای مرحله بعد</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Monitoring Plan -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="metric-card p-6 rounded-2xl">
                                <h4 class="font-semibold text-primary mb-4 flex items-center">
                                    <span class="mr-2">📅</span>پیگیری روزانه
                                </h4>
                                <ul class="space-y-2 text-sm">
                                    ${monitoringPlan.daily.map(item => `
                                        <li class="flex items-center">
                                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 flex-shrink-0"></span>
                                            ${item}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>

                            <div class="metric-card p-6 rounded-2xl">
                                <h4 class="font-semibold text-primary mb-4 flex items-center">
                                    <span class="mr-2">📊</span>ارزیابی هفتگی
                                </h4>
                                <ul class="space-y-2 text-sm">
                                    ${monitoringPlan.weekly.map(item => `
                                        <li class="flex items-center">
                                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 flex-shrink-0"></span>
                                            ${item}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>

                            <div class="metric-card p-6 rounded-2xl">
                                <h4 class="font-semibold text-primary mb-4 flex items-center">
                                    <span class="mr-2">🔍</span>بررسی ماهانه
                                </h4>
                                <ul class="space-y-2 text-sm">
                                    ${monitoringPlan.monthly.map(item => `
                                        <li class="flex items-center">
                                            <span class="w-2 h-2 bg-purple-500 rounded-full mr-2 flex-shrink-0"></span>
                                            ${item}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- Success Metrics -->
                        <div class="metric-card p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                                <span class="mr-2">🏆</span>شاخص‌های موفقیت
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 rounded-lg">
                                    <div class="text-2xl mb-2">💪</div>
                                    <div class="font-semibold text-green-700 dark:text-green-300">قدرت</div>
                                    <div class="text-sm text-green-600 dark:text-green-400">+30-60% افزایش</div>
                                </div>
                                <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-lg">
                                    <div class="text-2xl mb-2">❤️</div>
                                    <div class="font-semibold text-blue-700 dark:text-blue-300">استقامت</div>
                                    <div class="text-sm text-blue-600 dark:text-blue-400">+25-50% بهبود</div>
                                </div>
                                <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-lg">
                                    <div class="text-2xl mb-2">🎯</div>
                                    <div class="font-semibold text-purple-700 dark:text-purple-300">ترکیب بدن</div>
                                    <div class="text-sm text-purple-600 dark:text-purple-400">تغییر محسوس</div>
                                </div>
                                <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 rounded-lg">
                                    <div class="text-2xl mb-2">😊</div>
                                    <div class="font-semibold text-orange-700 dark:text-orange-300">کیفیت زندگی</div>
                                    <div class="text-sm text-orange-600 dark:text-orange-400">بهبود چشمگیر</div>
                                </div>
                            </div>
                        </div>

                        <!-- Warning Signs -->
                        <div class="border-2 border-red-200 dark:border-red-700 bg-red-50 dark:bg-red-900/20 p-6 rounded-2xl">
                            <h4 class="text-lg font-semibold text-red-700 dark:text-red-300 mb-4 flex items-center">
                                <span class="mr-2">⚠️</span>علائم هشدار - متوقف کردن تمرین
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <ul class="space-y-2 text-red-600 dark:text-red-400">
                                    <li>• درد شدید یا مداوم مفاصل</li>
                                    <li>• تنگی نفس غیرطبیعی</li>
                                    <li>• سرگیجه یا حالت تهوع</li>
                                </ul>
                                <ul class="space-y-2 text-red-600 dark:text-red-400">
                                    <li>• درد قفسه سینه</li>
                                    <li>• کاهش ناگهانی عملکرد</li>
                                    <li>• اختلال شدید در خواب</li>
                                </ul>
                            </div>
                            <p class="text-sm text-red-600 dark:text-red-400 mt-4 font-medium">
                                در صورت مشاهده هرکدام از این علائم، فوراً تمرین را متوقف کرده و با پزشک مشورت کنید.
                            </p>
                        </div>
                    </div>
                `;
            }

            setupResultsInteraction(analysis, program) {
                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetTab = btn.dataset.tab;
                        
                        // Remove active class from all buttons and contents
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                        
                        // Add active class and show content
                        btn.classList.add('tab-active');
                        const tabContent = document.getElementById(`tab-${targetTab}`);
                        if (tabContent) tabContent.classList.remove('hidden');
                    });
                });

                // Action buttons
                const restartBtn = document.getElementById('restartBtn');
                if (restartBtn) {
                    restartBtn.addEventListener('click', () => this.restart());
                }

                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => this.downloadProgram(analysis, program));
                }

                const shareBtn = document.getElementById('shareBtn');
                if (shareBtn) {
                    shareBtn.addEventListener('click', () => this.shareProgram());
                }
            }

            downloadProgram(analysis, program) {
                const results = {
                    userData: this.userData,
                    analysis: analysis,
                    program: program,
                    generatedAt: new Date().toISOString(),
                    version: '2.0.0'
                };

                const dataStr = JSON.stringify(results, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `برنامه-ورزشی-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

                this.showSuccess('برنامه کامل با موفقیت دانلود شد! 💾');
            }

            shareProgram() {
                if (navigator.share) {
                    navigator.share({
                        title: 'برنامه ورزشی شخصی‌سازی‌شده',
                        text: 'برنامه ورزشی علمی و شخصی‌سازی‌شده من از مربی هوشمند',
                        url: window.location.href
                    });
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        this.showSuccess('لینک در کلیپ‌بورد کپی شد! 📋');
                    });
                }
            }

            exportResults() {
                const results = {
                    userData: this.userData,
                    analysisResults: this.analysisResults,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(results, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `تحلیل-ورزشی-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.showSuccess('اطلاعات با موفقیت ذخیره شد! 💾');
            }

            restart() {
                this.currentStep = 1;
                this.userData = {};
                this.validationErrors = [];
                
                // Reset form
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                        const card = input.closest('.option-card');
                        if (card) card.classList.remove('selected');
                    } else {
                        input.value = '';
                    }
                    input.classList.remove('error-input', 'success-input');
                });

                // Reset sliders
                document.querySelectorAll('input[type="range"]').forEach(slider => {
                    slider.value = 5;
                    const valueSpan = document.getElementById(slider.id.replace('Priority', 'Value').replace('commitment', 'commitmentValue'));
                    if (valueSpan) valueSpan.textContent = '5';
                });

                // Hide results and show welcome
                document.getElementById('resultsDashboard').classList.add('hidden');
                document.getElementById('assessmentForm').classList.add('hidden');
                document.getElementById('welcomeSection').classList.remove('hidden');
                document.getElementById('exportData').classList.add('hidden');

                // Hide dynamic results
                ['bmiResult', 'fitnessResult', 'bodyTypeResult', 'goalAnalysis', 'finalAnalysis'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.classList.add('hidden');
                });

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-up max-w-md';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-xl mr-2">❌</span>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-up max-w-md';
                successDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-xl mr-2">✅</span>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme management
            new AdvancedThemeManager();
            
            // Initialize main assessment system
            new IntelligentAssessmentManager();
            
            // Add loading states for better UX
            document.body.classList.add('animate-fade-in');
            
            // Console welcome message
            console.log('%c🚀 مربی هوشمند - سیستم تحلیل علمی پیشرفته', 'color: #5D5CDE; font-size: 16px; font-weight: bold;');
            console.log('%cسیستم آماده و قابل استفاده است!', 'color: #10b981; font-size: 14px;');
        });
    </script>
</body>
</html>